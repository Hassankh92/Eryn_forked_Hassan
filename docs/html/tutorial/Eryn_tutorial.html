

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Eryn Basic Tutorial &mdash; Eryn 0.0.1 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "document", "processHtmlClass": "math|output_area"}}</script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Utilities" href="../user/utils.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: coral" >
          

          
            <a href="../index.html" class="icon icon-home"> Eryn
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Documentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../user/ensemble.html">Ensemble</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/state.html">State</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/backend.html">Backends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/moves.html">Moves</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/prior.html">Priors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/temper.html">Parallel Tempering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../user/utils.html">Utilities</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorial:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Eryn Basic Tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#MCMC-Basics">MCMC Basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="#The-Tree-Metaphor">The Tree Metaphor</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Getting-Started-with-the-Ensemble-Sampler">Getting Started with the Ensemble Sampler</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Backend-Objects">Backend Objects</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#5-dimensional-Arrays">5-dimensional Arrays</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#State-Objects">State Objects</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Branches">Branches</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Parallel-Tempering">Parallel Tempering</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Add-Reversible-Jump-MCMC-(model-count-uncertainty)">Add Reversible Jump MCMC (model count uncertainty)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Add-multiple-branches">Add multiple branches</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#Searching-for-Gaussian-pulses-in-2D">Searching for Gaussian pulses in 2D</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#Moves">Moves</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Metropolis-Hastings">Metropolis-Hastings</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Red-Blue">Red Blue</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Reversible-Jump">Reversible Jump</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Group-Moves">Group Moves</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Gibbs-Sampling">Gibbs Sampling</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Utilities">Utilities</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Transform-Container">Transform Container</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#Choosing-the-optimal-B-Spline-order">Choosing the optimal B-Spline order</a></li>
<li class="toctree-l1"><a class="reference internal" href="#\sim-fin-\sim"><span class="math notranslate nohighlight">\(\sim fin \sim\)</span></a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Eryn</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Eryn Basic Tutorial</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/tutorial/Eryn_tutorial.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <div class="rst-breadcrumbs-buttons" role="navigation" aria-label="breadcrumb navigation">
      
      
        <a href="../user/utils.html" class="btn btn-neutral float-left" title="Utilities" accesskey="p"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
      
  </div>
  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">eryn.ensemble</span> <span class="kn">import</span> <span class="n">EnsembleSampler</span>
<span class="kn">from</span> <span class="nn">eryn.state</span> <span class="kn">import</span> <span class="n">State</span>
<span class="kn">from</span> <span class="nn">eryn.prior</span> <span class="kn">import</span> <span class="n">ProbDistContainer</span><span class="p">,</span> <span class="n">uniform_dist</span>
<span class="kn">from</span> <span class="nn">eryn.utils</span> <span class="kn">import</span> <span class="n">TransformContainer</span>
<span class="kn">from</span> <span class="nn">eryn.moves</span> <span class="kn">import</span> <span class="n">GaussianMove</span>
<span class="kn">from</span> <span class="nn">eryn.backends</span> <span class="kn">import</span> <span class="n">HDFBackend</span>

<span class="c1"># make the plots look a bit nicer with some defaults</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">rcparams</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">rcparams</span><span class="p">[</span><span class="s2">&quot;axes.linewidth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">rcparams</span><span class="p">[</span><span class="s2">&quot;font.family&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;serif&quot;</span>
<span class="n">rcparams</span><span class="p">[</span><span class="s2">&quot;font.size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">22</span>
<span class="n">rcparams</span><span class="p">[</span><span class="s2">&quot;legend.fontsize&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">16</span>
<span class="n">rcparams</span><span class="p">[</span><span class="s2">&quot;mathtext.fontset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;stix&quot;</span>
<span class="n">rcparams</span><span class="p">[</span><span class="s2">&quot;text.usetex&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">rcparams</span><span class="p">)</span> <span class="c1"># update plot parameters</span>

<span class="c1"># set random seed</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">corner</span>
<span class="kn">from</span> <span class="nn">chainconsumer</span> <span class="kn">import</span> <span class="n">ChainConsumer</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">interpolate</span>
</pre></div>
</div>
</div>
<section id="Eryn-Basic-Tutorial">
<h1>Eryn Basic Tutorial<a class="headerlink" href="#Eryn-Basic-Tutorial" title="Permalink to this headline">¶</a></h1>
<p>Eryn is an advanced MCMC sampler. It has the capability to run with parallel tempering, multiple model types, and unknown counts within each model type using Reversible-Jump MCMC techniques. Eryn is heavily based on <a class="reference external" href="https://emcee.readthedocs.io/en/stable/">emcee</a>. The <code class="docutils literal notranslate"><span class="pre">emcee</span></code> base structure with the Ensemble Sampler, State objects, proposal setup, and storage backends is carried over into Eryn with small changes to account for the increased complexity. In a simple sense, Eryn is an
advanced (and slightly more complicated) version of <code class="docutils literal notranslate"><span class="pre">emcee</span></code>.</p>
<p>In this tutorial, we will go through much of what is available in Eryn. We will start with a basic sampling operation to illustrate how to build and navigate common objects in Eryn. We will then scale up the complexity to understand how to use Eryn in different circumstances.</p>
<p>If you use Eryn in your publication, please cite the paper (# TODO: add paper), its zenodo (# TODO: add zenodo as well), and <a class="reference external" href="https://emcee.readthedocs.io/en/stable/">emcee</a>. The documentation for Eryn can be found here: <a class="reference external" href="https://mikekatz04.gihub.io/Eryn">mikekatz04.gihub.io/Eryn</a>. You will find the code on Github: <a class="reference external" href="https://github.com/mikekatz04/Eryn">github.com/mikekatz04/Eryn</a>.</p>
<section id="MCMC-Basics">
<h2>MCMC Basics<a class="headerlink" href="#MCMC-Basics" title="Permalink to this headline">¶</a></h2>
<p>Here we will go through the basics of MCMC. For a better overall understanding of MCMC, see the Eryn paper: (# TODO: add paper).</p>
<p>The goal of MCMC is to assess the posterior probablity on parameters <span class="math notranslate nohighlight">\((\vec{\theta})\)</span> from a model (<span class="math notranslate nohighlight">\(\mathcal{M}\)</span>), given some data <span class="math notranslate nohighlight">\(y\)</span>: <span class="math notranslate nohighlight">\(p(\vec{\theta}, \mathcal{M}|y)\)</span>. We can rewrite this probability using Bayes’ rule:</p>
<div class="math notranslate nohighlight">
\[p(\vec{\theta}|y)=\frac{p(y|\vec{\theta}, \mathcal{M})p(\vec{\theta}, \mathcal{M})}{p(y|\mathcal{M})}\]</div>
<p>Here are the main pieces of the righthand side: * Posterior - <span class="math notranslate nohighlight">\(p(\vec{\theta}|y)\)</span>: The probability distribution on the parameters, the main goal of MCMC. We will refer to this from now on as <span class="math notranslate nohighlight">\(\pi(\vec{\theta})\)</span>. * Likelihood - <span class="math notranslate nohighlight">\(p(y|\vec{\theta}, \mathcal{M})\)</span>: This is the surface that MCMC will sample (weighted by the prior). We will refer to the Likelihood. We will write this from now on as <span class="math notranslate nohighlight">\(\mathcal{L}(\vec{\theta}, \mathcal{M})\)</span>. * Prior -
<span class="math notranslate nohighlight">\(p(\vec{\theta}, \mathcal{M})\)</span>: Prior probability on the parameters and the model chosen. * Evidence - <span class="math notranslate nohighlight">\(p(y|\mathcal{M})\)</span>: The evidence is the integral of the numerator in the equation above integrated over all of the parameter space: <span class="math notranslate nohighlight">\(\int_{\vec{\theta}_\mathcal{M}}\mathcal{L}(\vec{\theta}, \mathcal{M})d\vec{\theta}\)</span>. This will be referred to below as <span class="math notranslate nohighlight">\(Z(\mathcal{M})\)</span> (the evidence of model <span class="math notranslate nohighlight">\(\mathcal{M}\)</span>).</p>
<p>MCMC numerically draws samples from the posterior density by exploring the Likelihood surface weighted by the prior. In most MCMC applications, the evidence will be intractable and ignored as it is just a constant factor over all samples. There are methods to estimate the evidence that we will discuss below.</p>
<p>MCMC is special because of <strong>how it explores</strong>. Using a concept called “Detailed Balance,” walkers exploring the Likelihood surface preferentially move upwards, but probabilistically can move downwards. This allows for a full exploration of the peak of the Likelihood surface rather than just moving directly towards the highest point.</p>
<p>There are requirements to make this work properly that we will discuss below when we discsuss MCMC “moves” or “proposals.” At a basic level, also know as the Metropolis-Hastings algorithm, MCMC works like this: 1. It starts with a current point in parameter space, <span class="math notranslate nohighlight">\(\vec{\theta}_t\)</span>. 2. The sampler proposes a new position for this walker: <span class="math notranslate nohighlight">\(\vec{\theta}_{t+1}\)</span>. 3. It then accepts this new position with probabilty, <span class="math notranslate nohighlight">\(\alpha\)</span>:</p>
<div class="math notranslate nohighlight">
\[\min\left(1, \frac{\pi(\vec{\theta}_{t+1})q(\vec{\theta}_{t}|\vec{\theta}_{t+1})}{\pi(\vec{\theta}_{t})q(\vec{\theta}_{t+1}|\vec{\theta}_{t})}\right)\]</div>
<ol class="arabic simple" start="4">
<li><p>Repeat many times.</p></li>
</ol>
<p><span class="math notranslate nohighlight">\(q\)</span> is the proposal distribution to move from <span class="math notranslate nohighlight">\(\vec{\theta}_{t}\)</span> to <span class="math notranslate nohighlight">\(\vec{\theta}_{t+1}\)</span> or vice versa. If the proposal distribution is symmetric, the <span class="math notranslate nohighlight">\(q\)</span> distributions drop out and we are left with the fraction of posterior probabilities. We can see, in this case, if the new posterior probability is larger than the previous probability, the move will ALWAYS be accepted. If the new posterior probability is worse than the old probability, the move will be accepted with a
probability equal to this fraction. Therefore, as the new value becomes worse and worse compared to the old value, the probability of acceptance decreases.</p>
</section>
<section id="The-Tree-Metaphor">
<h2>The Tree Metaphor<a class="headerlink" href="#The-Tree-Metaphor" title="Permalink to this headline">¶</a></h2>
<p>Before we get into using the sampler, we will discuss the “infamous” tree metaphor. It helped in thinking about the early creation of Eryn and has carried through to the end. <code class="docutils literal notranslate"><span class="pre">Eryn</span></code> is the Sindarin word for “forest” or “woods.” The purpose of this metaphor is to simplify the complex dimensionality associated with changing models and model counts in MCMC. We choose not to use “model” and “model counts” everywhere because those descriptions can quickly become confusing.</p>
<p>We start with a forest with a bunch of trees. These trees are the MCMC “walkers”. Each tree will have the same number of branches which is fixed throughout a sampling run (i.e. each walker has the same base setup). These branches are our different model types. For example, if you have a signal that is a combination of sine waves and Gaussians. In this case, you have two branches, one for the “sine wave” model and one for the “Gaussian” model. The number of Gaussians or sine waves is accounted
for as the number of “leafs” on each branch. So, if 1 walker has 3 Gaussians and 2 sine waves, we can imagine this as a tree with two branches. The first branch for sine waves has 2 leaves and the second branch as 3 leaves for 3 Gaussians.</p>
<p>When we get to parallel tempering, you can imagine different forests at different temperatures, all having the same number of trees (walkers).</p>
<p>(# TODO: add image)</p>
</section>
<section id="Getting-Started-with-the-Ensemble-Sampler">
<h2>Getting Started with the Ensemble Sampler<a class="headerlink" href="#Getting-Started-with-the-Ensemble-Sampler" title="Permalink to this headline">¶</a></h2>
<p>Let’s start by running on a simple multivariate Gaussian likelihood:</p>
<div class="math notranslate nohighlight">
\[\ln{\mathcal{L}}\propto -\frac{1}{2}(\vec{x} - \vec{\mu})^T \tilde{C}^{-1} (\vec{x} - \vec{\mu})\]</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Gaussian likelihood</span>
<span class="k">def</span> <span class="nf">log_like_fn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">invcov</span><span class="p">):</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">mu</span>
    <span class="k">return</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">diff</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">invcov</span><span class="p">,</span> <span class="n">diff</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

</pre></div>
</div>
</div>
<p>Add the initial settings: number of dimensions and number of walkers. Then, generate a covariance matrix for the given dimensionality for the likelihood and a set of means for each component of the Gaussian.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ndim</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">nwalkers</span> <span class="o">=</span> <span class="mi">100</span>

<span class="c1"># mean</span>
<span class="n">means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ndim</span><span class="p">)</span>  <span class="c1"># np.random.rand(ndim)</span>

<span class="c1"># define covariance matrix</span>
<span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ndim</span><span class="p">))</span>
<span class="n">invcov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Next we will build our priors. For simplicity (and based on this problem), we will use a hyper-cube centered on the means with side length set to be <code class="docutils literal notranslate"><span class="pre">2</span> <span class="pre">*</span> <span class="pre">lims</span></code>. Eryn requires a class object as the prior with an <code class="docutils literal notranslate"><span class="pre">logpdf</span></code> method (similar to <code class="docutils literal notranslate"><span class="pre">scipy.stats</span></code> distributions). Eryn provides a helper class to aid in this process: <code class="docutils literal notranslate"><span class="pre">`eryn.prior.ProbDistContainer</span></code> &lt;<a class="reference external" href="https://mikekatz04.github.io/Eryn/build/html/user/prior.html#prior-container">https://mikekatz04.github.io/Eryn/build/html/user/prior.html#prior-container</a>&gt;`__. This class takes a dictionary as input. In the simplest
form, the keys are integers representing the index into the array of parameters and the values are the associated distributions: <code class="docutils literal notranslate"><span class="pre">{index:</span> <span class="pre">distribution}</span></code>. Eryn has a wrapper for the <code class="docutils literal notranslate"><span class="pre">scipy.stats.uniform</span></code> class that allows you to enter the start and stop points: <code class="docutils literal notranslate"><span class="pre">`eryn.prior.uniform</span></code> &lt;<a class="reference external" href="https://mikekatz04.github.io/Eryn/build/html/user/prior.html#eryn.prior.uniform_dist">https://mikekatz04.github.io/Eryn/build/html/user/prior.html#eryn.prior.uniform_dist</a>&gt;`__. For example, if we have a 3D space with uniform priors for all dimensions from -1 to 1, the input dictionary would look
like this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>priors_in = {
    0: uniform_dist(-1, 1),
    1: uniform_dist(-1, 1),
    2: uniform_dist(-1, 1)
}
</pre></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># set prior limits</span>
<span class="n">lims</span> <span class="o">=</span> <span class="mf">5.0</span>
<span class="n">priors_in</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">uniform_dist</span><span class="p">(</span><span class="o">-</span><span class="n">lims</span> <span class="o">+</span> <span class="n">means</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lims</span> <span class="o">+</span> <span class="n">means</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">)}</span>
<span class="n">priors</span> <span class="o">=</span> <span class="n">ProbDistContainer</span><span class="p">(</span><span class="n">priors_in</span><span class="p">)</span>

</pre></div>
</div>
</div>
<p>In this case, we are not going to use really any of Eryn’s special capabilities. This will allow us to focus on how to navigate the sampler and deal with its output. Then we can add the fun stuff!</p>
<p>The object that directs everything in Eryn (like in <code class="docutils literal notranslate"><span class="pre">emcee</span></code>) is <code class="docutils literal notranslate"><span class="pre">`eryn.ensemble.EnsembleSampler</span></code> &lt;<a class="reference external" href="https://mikekatz04.github.io/Eryn/build/html/user/ensemble.html#eryn.ensemble.EnsembleSampler">https://mikekatz04.github.io/Eryn/build/html/user/ensemble.html#eryn.ensemble.EnsembleSampler</a>&gt;`__. It required arguments are number of walkers, dimensionality of inputs (for this simple case this is an integer), the log likelihood function, and the priors. Similar to <code class="docutils literal notranslate"><span class="pre">emcee</span></code>, you can add arguments and keyword arguments to the Likelihood function by providing the <code class="docutils literal notranslate"><span class="pre">args</span></code> and <code class="docutils literal notranslate"><span class="pre">kwargs</span></code> keyword
arguments to the <code class="docutils literal notranslate"><span class="pre">EnsembleSampler</span></code>. In this case, we add the means and inverse of the covariance matrix as extra arguments.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ensemble</span> <span class="o">=</span> <span class="n">EnsembleSampler</span><span class="p">(</span>
    <span class="n">nwalkers</span><span class="p">,</span>
    <span class="n">ndim</span><span class="p">,</span>
    <span class="n">log_like_fn</span><span class="p">,</span>
    <span class="n">priors</span><span class="p">,</span>
    <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">means</span><span class="p">,</span> <span class="n">invcov</span><span class="p">],</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>Now we will get starting positions for our walkers by sampling from the priors using the <code class="docutils literal notranslate"><span class="pre">rvs</span></code> method of the <code class="docutils literal notranslate"><span class="pre">ProbDistContainer</span></code> and then evaluating the associated Likelihood and prior values. The <code class="docutils literal notranslate"><span class="pre">rvs</span></code> method is also called like in <code class="docutils literal notranslate"><span class="pre">scipy.stats</span></code> distributions.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># starting positions</span>
<span class="c1"># randomize throughout prior</span>
<span class="n">coords</span> <span class="o">=</span> <span class="n">priors</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">nwalkers</span><span class="p">,))</span>

<span class="c1"># check log_like</span>
<span class="n">log_like</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span>
    <span class="n">log_like_fn</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">means</span><span class="p">,</span> <span class="n">invcov</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nwalkers</span><span class="p">)])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">log_like</span><span class="p">)</span>

<span class="c1"># check log_prior</span>
<span class="n">log_prior</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span>
    <span class="n">priors</span><span class="o">.</span><span class="n">logpdf</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nwalkers</span><span class="p">)])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">log_prior</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[-30.69858605 -27.88613553 -10.22294092 -14.70569247 -18.96300942
 -40.24777582 -18.73441074 -24.83741982 -29.01040764 -27.8427905
 -15.6395355  -37.63324244 -37.32945619 -23.65755241 -14.71578138
 -17.41587351 -10.60372232 -14.78508305 -16.44610878 -14.65807937
 -10.96569731 -21.07245692 -21.71012131 -11.7938995  -26.68678623
 -10.56139796 -21.07206293 -15.22766639 -21.70138195 -21.66486977
 -12.67496753 -16.03289018 -29.46929288 -26.72131899 -44.24698912
 -21.3584848  -19.77366496 -28.72150734  -5.84518648 -33.37118884
 -36.15731891 -25.26041351 -25.57594664 -12.25802303 -22.37039294
 -31.88982593 -15.35309536 -24.45627855 -22.46651653 -23.11210745
 -25.31311317 -14.36123373 -23.67409531 -23.41272599 -34.51272062
 -13.40386882 -42.6083427  -10.3819265  -33.56151466 -19.79275524
 -10.09464227 -17.63670509 -15.88594767  -1.5583328  -38.33786195
 -10.04251137 -22.92432228 -26.5383962  -29.02898281 -34.39747766
 -29.93610511 -43.67631032 -37.6288042  -26.57863213 -12.43201382
 -21.71339587 -24.98065915 -22.34629761 -28.53454745 -20.72808992
 -23.58751379 -13.39368888 -12.15662608 -32.82365756  -8.14075088
 -26.22668818 -20.43301692  -8.79050623 -23.10278803 -16.10581548
 -38.66327643 -21.96839538 -19.91765459 -10.73450427 -13.25399003
 -11.51642261 -12.99636574 -21.3527218  -33.90758502 -35.26045709]
[-11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
 -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
 -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
 -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
 -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
 -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
 -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
 -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
 -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
 -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
 -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
 -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
 -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
 -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
 -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
 -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
 -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
 -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
 -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
 -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546]
</pre></div></div>
</div>
<p>Because we are in the unit cube, the prior values are constant.</p>
<p>Now, we can run the sampler using the <code class="docutils literal notranslate"><span class="pre">run_mcmc</span></code> method on the <code class="docutils literal notranslate"><span class="pre">EnsembleSampler</span></code> class. It first takes as an argument an array of the starting positions (or a <code class="docutils literal notranslate"><span class="pre">State</span></code> object which we will cover below). We also must provide the number of steps as the second argument. Helpful kwargs (not all inclusive):</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">burn</span></code>: Perform a burn in for a certain number of proposals.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">progress</span></code>: If <code class="docutils literal notranslate"><span class="pre">True</span></code>, show the progress as the sampler runs.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">thin_by</span></code>: How much to thin the chain directly before storage.</p></li>
</ul>
<p>The total number of proposals the sampler will do is <code class="docutils literal notranslate"><span class="pre">nsteps</span> <span class="pre">*</span> <span class="pre">thin_by</span></code>. It will store <code class="docutils literal notranslate"><span class="pre">nsteps</span></code> samples.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">nsteps</span> <span class="o">=</span> <span class="mi">500</span>
<span class="c1"># burn for 1000 steps</span>
<span class="n">burn</span> <span class="o">=</span> <span class="mi">100</span>
<span class="c1"># thin by 5</span>
<span class="n">thin_by</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">run_mcmc</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">nsteps</span><span class="p">,</span> <span class="n">burn</span><span class="o">=</span><span class="n">burn</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">thin_by</span><span class="o">=</span><span class="n">thin_by</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|██████████| 100/100 [00:00&lt;00:00, 622.79it/s]
100%|██████████| 2500/2500 [00:04&lt;00:00, 595.28it/s]
</pre></div></div>
</div>
<p>Similar to <code class="docutils literal notranslate"><span class="pre">emcee</span></code>, all of the sampler information is stored in a backend object. In the default case, this backend is <code class="docutils literal notranslate"><span class="pre">`eryn.backends.Backend</span></code> &lt;<a class="reference external" href="https://mikekatz04.github.io/Eryn/build/html/user/backend.html#eryn.backends.Backend">https://mikekatz04.github.io/Eryn/build/html/user/backend.html#eryn.backends.Backend</a>&gt;`__. To retrieve the samples from the backend, you call the <code class="docutils literal notranslate"><span class="pre">get_chain</span></code> method. This will return a dictionary with keys at the omdel names and a 5-dimensional array per model, which can be intimidating. We will cover that array just below. For now, just focus on
the output of the sampler.</p>
<p>We will first generate corner plot. In this initial example, we have not defined branch names, therefore, the sampler has assigned our problem default branch names <code class="docutils literal notranslate"><span class="pre">model_0</span></code>,…,<code class="docutils literal notranslate"><span class="pre">model_n</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">samples</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">get_chain</span><span class="p">()[</span><span class="s1">&#39;model_0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ndim</span><span class="p">)</span>

<span class="n">c</span> <span class="o">=</span> <span class="n">ChainConsumer</span><span class="p">()</span>
<span class="n">c</span><span class="o">.</span><span class="n">add_chain</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;$x_</span><span class="si">{}</span><span class="s2">$&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#6495ed&#39;</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">shade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shade_alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">bar_shade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">usetex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">plotter</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">12</span><span class="p">),</span> <span class="n">truth</span><span class="o">=</span><span class="n">means</span><span class="p">);</span>

<span class="c1"># Or use the corner package</span>
<span class="c1"># corner.corner(samples, truths=means)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_23_0.png" src="../_images/tutorial_Eryn_tutorial_23_0.png" />
</div>
</div>
<p>Now we will plot the chains.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#### Chains</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ndim</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">13</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">walk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nwalkers</span><span class="p">):</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">get_chain</span><span class="p">()[</span><span class="s1">&#39;model_0&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">walk</span><span class="p">,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_25_0.png" src="../_images/tutorial_Eryn_tutorial_25_0.png" />
</div>
</div>
</section>
<section id="Backend-Objects">
<h2>Backend Objects<a class="headerlink" href="#Backend-Objects" title="Permalink to this headline">¶</a></h2>
<p>Backends are where all of the information in the sampler is stored as it runs. It is from these backends that samples are retrieved for plotting. You can find the documentation for the Backend objects <a class="reference external" href="https://mikekatz04.github.io/Eryn/html/user/backend.html#backends">here</a>. Here, we will go through the most commonly used functions from the backend: * <code class="docutils literal notranslate"><span class="pre">get_chain</span></code>: retrieve all of the samples stored over the course of the sampling run. * <code class="docutils literal notranslate"><span class="pre">get_log_like</span></code>: retrieve the log of the Likelihood
for each sample. * <code class="docutils literal notranslate"><span class="pre">get_log_prior</span></code>: retrieve the log of the prior for each sample. * <code class="docutils literal notranslate"><span class="pre">get_a_sample</span></code>: retrieve a state object from a specific iteration. <code class="docutils literal notranslate"><span class="pre">get_last_sample</span></code> may be more common. It is just a specific example of <code class="docutils literal notranslate"><span class="pre">get_a_sample</span></code> for the last sample.</p>
<p>Many (but not all) of the methods from the backend object are also raised to the level of sampler. So you can either call <code class="docutils literal notranslate"><span class="pre">EnsembleSampler.backend.method</span></code> or <code class="docutils literal notranslate"><span class="pre">EnsembleSampler.method</span></code> and it will be equivalent.</p>
<p>Common properties to get from the backend: * <code class="docutils literal notranslate"><span class="pre">shape</span></code>: returns a dictionary with keys for each branch name and values as tuples representing the specific shape for each model (this shape will not include the <code class="docutils literal notranslate"><span class="pre">nsteps</span></code> outer dimension. * <code class="docutils literal notranslate"><span class="pre">iteration</span></code>: number of stored iterations in the backend.</p>
<p>Now we will get the likelihood and prior. Notice the shape of the Likelihood is <code class="docutils literal notranslate"><span class="pre">(nsteps,</span> <span class="pre">ntemps,</span> <span class="pre">nwalkers)</span></code> (in this example we have 1 temperature). This will always be the shape of quantities that are a single value per walker (e.g. Likelihood, prior, posterior).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ll</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">get_log_like</span><span class="p">()</span>
<span class="n">lp</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">get_log_prior</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of iterations </span><span class="si">{</span><span class="n">ensemble</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">iteration</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="c1"># equivalent to ensemble.get_log_like() and ensemble.get_log_prior()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">ll</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">ll</span><span class="p">,</span> <span class="n">lp</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Number of iterations 500
(500, 1, 100) [[[-1.05297225 -2.81695595 -0.80839791 ... -1.30449907 -2.65001331
   -1.72492908]]

 [[-3.51878996 -0.89787788 -4.49356178 ... -4.65518146 -3.7436319
   -1.66068016]]

 [[-2.03059694 -1.49585829 -3.90577462 ... -1.04656098 -2.0396035
   -0.80658449]]

 ...

 [[-1.73887276 -2.27535667 -1.36789573 ... -1.19099689 -2.72232295
   -5.43958501]]

 [[-1.44427868 -1.05581352 -4.30749439 ... -1.85688564 -2.11343788
   -2.24766066]]

 [[-0.6654815  -2.28154314 -2.00102494 ... -1.6139005  -1.08899932
   -2.1398411 ]]] [[[-11.51292546 -11.51292546 -11.51292546 ... -11.51292546 -11.51292546
   -11.51292546]]

 [[-11.51292546 -11.51292546 -11.51292546 ... -11.51292546 -11.51292546
   -11.51292546]]

 [[-11.51292546 -11.51292546 -11.51292546 ... -11.51292546 -11.51292546
   -11.51292546]]

 ...

 [[-11.51292546 -11.51292546 -11.51292546 ... -11.51292546 -11.51292546
   -11.51292546]]

 [[-11.51292546 -11.51292546 -11.51292546 ... -11.51292546 -11.51292546
   -11.51292546]]

 [[-11.51292546 -11.51292546 -11.51292546 ... -11.51292546 -11.51292546
   -11.51292546]]]
</pre></div></div>
</div>
<section id="5-dimensional-Arrays">
<h3>5-dimensional Arrays<a class="headerlink" href="#5-dimensional-Arrays" title="Permalink to this headline">¶</a></h3>
<p>The chain information is returned as a dictionary with keys as the branch names and values as 5-dimensional arrays: <code class="docutils literal notranslate"><span class="pre">(nsteps,</span> <span class="pre">ntemps,</span> <span class="pre">nwalkers,</span> <span class="pre">nleaves_max,</span> <span class="pre">ndim)</span></code>. For clarity: * nsteps: number of sampler iterations stored (time evolution of each forest) * ntemps: number of temperatures (which forest you are in) * nwalkers: number of walkers (which tree) * nleaves_max: maximum number of model counts or leaves for each specific branch. * ndim: number of parameters describing a single
model or leaf.</p>
<p>In our simple example, we have 1 temperature and our maximum leaf count is 1.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># getting the chain</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">get_chain</span><span class="p">()</span>

<span class="c1"># same as</span>
<span class="c1"># samples = enseble.backend.get_chain()</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">samples</span><span class="p">),</span> <span class="n">samples</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">samples</span><span class="p">[</span><span class="s2">&quot;model_0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;class &#39;dict&#39;&gt; dict_keys([&#39;model_0&#39;]) (500, 1, 100, 1, 5)
</pre></div></div>
</div>
<p>We can also get the shape information direct from the backend:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ensemble</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;model_0&#39;: (1, 100, 1, 5)}
</pre></div></div>
</div>
</section>
</section>
<section id="State-Objects">
<h2>State Objects<a class="headerlink" href="#State-Objects" title="Permalink to this headline">¶</a></h2>
<p>Now, we are going to look at <code class="docutils literal notranslate"><span class="pre">`State</span></code> &lt;<a class="reference external" href="https://mikekatz04.github.io/Eryn/build/html/user/state.html#eryn.state.State">https://mikekatz04.github.io/Eryn/build/html/user/state.html#eryn.state.State</a>&gt;`__ objects. They carry the current information throughout the sampler about the current state of the sampler. In our simple example, we can examine the current coordinates, likelihood, and prior values.</p>
<p>Output from the sampler above is the last state of the sampler <code class="docutils literal notranslate"><span class="pre">out</span></code>. This will include any additional objects passed through the sampler like <code class="docutils literal notranslate"><span class="pre">BranchSupplimental</span></code> objects that we will explain below.</p>
<p>Another way to retrieve the last state is from the backend. That is what we will do here. However, please note, that supplimental information (discussed below) is not stored in the backend, so the state that is returned from the backend will have information that is stored in the backend, but not supplimental information that was passed through the sampler at runtime.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">last_state</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">get_last_sample</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">last_state</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;class &#39;eryn.state.State&#39;&gt;
</pre></div></div>
</div>
<p>We can access the Likelihood and prior values as <code class="docutils literal notranslate"><span class="pre">State.log_like</span></code> and <code class="docutils literal notranslate"><span class="pre">State.log_prior</span></code>. We can also ask the state to give use the posterior probability with the <code class="docutils literal notranslate"><span class="pre">get_log_prob</span></code> method. Note that shape of these values is <code class="docutils literal notranslate"><span class="pre">(ntemps,</span> <span class="pre">nwalkers)</span></code>. This is because <code class="docutils literal notranslate"><span class="pre">State</span></code> objects represent one moment in time in the sample, so they do not have the <code class="docutils literal notranslate"><span class="pre">nsteps</span></code> outer dimension that the backend has.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">log_like</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">log_like</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">log_prior</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">get_log_prob</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(1, 100) [[-0.6654815  -2.28154314 -2.00102494 -4.41852808 -1.87391204 -3.05035603
  -1.47197889 -3.04722716 -3.8519063  -2.53028792 -1.47895075 -0.91435392
  -4.67615627 -6.59494035 -3.09579563 -2.31956089 -3.61486196 -1.12447462
  -2.1692713  -4.54813706 -5.47761491 -1.81600973 -2.57141612 -3.18369399
  -8.03114163 -4.03929851 -1.37835437 -1.41370852 -2.04192051 -4.24060107
  -1.81791365 -1.43145056 -1.01976309 -1.08419629 -3.29498179 -2.08090042
  -3.03457142 -0.97839311 -1.45783438 -0.54860516 -0.39096809 -1.63453914
  -2.05034555 -1.13275529 -2.13057916 -3.21847262 -2.14804885 -2.15556008
  -1.92686111 -1.99795709 -0.35164059 -1.21098077 -1.21647944 -1.15304968
  -3.4313149  -4.70693915 -1.4318716  -4.84488379 -2.02338003 -2.07328961
  -2.98861309 -1.0448529  -4.76536477 -1.86707428 -1.24040534 -1.52161672
  -0.93361207 -1.10290796 -1.69669336 -0.98189704 -5.90223547 -3.3408396
  -2.12094704 -3.14709346 -0.37990706 -1.48720061 -3.15361028 -1.1595534
  -1.80055637 -1.59197714 -3.34129599 -1.36805722 -2.01708067 -3.58699943
  -2.32689704 -2.58811303 -2.7197202  -2.05348442 -1.2112424  -1.3357544
  -1.65449106 -1.68322549 -1.04792421 -1.13391508 -2.31811812 -2.46163754
  -5.10129065 -1.6139005  -1.08899932 -2.1398411 ]] [[-11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
  -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
  -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
  -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
  -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
  -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
  -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
  -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
  -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
  -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
  -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
  -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
  -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
  -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
  -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
  -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
  -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
  -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
  -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546
  -11.51292546 -11.51292546 -11.51292546 -11.51292546 -11.51292546]] [[-12.178406967597018 -13.794468601537229 -13.51395040804473
  -15.931453545910662 -13.386837504796224 -14.563281497846829
  -12.984904356428126 -14.560152628566094 -15.364831763416989
  -14.043213387296886 -12.991876210506318 -12.427279383435607
  -16.18908173602542 -18.107865819910735 -14.608721090901623
  -13.832486351401688 -15.12778742254714 -12.637400087040206
  -13.682196761468905 -16.061062522948745 -16.99054037739138
  -13.328935193719195 -14.084341581952058 -14.696619458753926
  -19.544067098137223 -15.552223973129747 -12.89127983919111
  -12.926633980338917 -13.55484597643607 -15.753526531972273
  -13.330839113958634 -12.944376020031633 -12.532688554298963
  -12.597121756200298 -14.807907257937872 -13.593825884034455
  -14.547496880273862 -12.491318574369066 -12.970759842526956
  -12.061530625801362 -11.903893550359193 -13.147464607768942
  -13.563271019780707 -12.64568075132453 -13.643504626290895
  -14.731398085093454 -13.660974318785833 -13.668485545961143
  -13.439786571171963 -13.510882553516781 -11.864566059032157
  -12.72390623089636 -12.729404901485783 -12.665975147003136
  -14.94424036264724 -16.219864618156716 -12.944797066539389
  -16.357809250310932 -13.536305491515654 -13.586215078293383
  -14.501538559296131 -12.557778368205309 -16.278290231060463
  -13.37999974857351 -12.753330808148338 -13.034542185913606
  -12.44653753837222 -12.61583342786152 -13.209618824491073
  -12.494822509135583 -17.415160934688622 -14.8537650614948
  -13.633872503903893 -14.66001892478048 -11.892832526613594
  -13.000126072062562 -14.666535740104562 -12.672478860022272
  -13.313481837705911 -13.104902607647315 -14.854221450723335
  -12.880982689335216 -13.530006134397748 -15.099924895847023
  -13.839822509144446 -14.101038497292365 -14.232645664310798
  -13.566409885481924 -12.724167865929159 -12.848679866185286
  -13.167416523641707 -13.196150950789018 -12.560849676395932
  -12.646840543492647 -13.831043581839076 -13.974563002223718
  -16.614216117226597 -13.126825968142406 -12.601924782141412
  -13.65276656606936]]
</pre></div></div>
</div>
<section id="Branches">
<h3>Branches<a class="headerlink" href="#Branches" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">State</span></code> objects store quantities at are single values per walker directly in the state as shown above (e.g. <code class="docutils literal notranslate"><span class="pre">State.log_like</span></code>). Information that gets down to the individual branch (or model type) level is stored in a <code class="docutils literal notranslate"><span class="pre">`Branch</span></code> &lt;<a class="reference external" href="https://mikekatz04.github.io/Eryn/html/user/state.html#eryn.state.Branch">https://mikekatz04.github.io/Eryn/html/user/state.html#eryn.state.Branch</a>&gt;`__ object. These <code class="docutils literal notranslate"><span class="pre">Branch</span></code> objects are stored in a dictionary within the <code class="docutils literal notranslate"><span class="pre">State</span></code> object with keys as branch names and values as the <code class="docutils literal notranslate"><span class="pre">Branch</span></code> object associated with that branch name. The
branch objects can be accessed as <code class="docutils literal notranslate"><span class="pre">state.branches[model_name]</span></code>. With in the branch object, the coordinates are stored. A few other things are stored, but we will get to that later. If you want a dictionary with keys at the branch names and values as the current coordinates, you can also use the property: <code class="docutils literal notranslate"><span class="pre">state.branches_coords</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">last_state</span><span class="o">.</span><span class="n">branches</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;model_0&#39;: &lt;eryn.state.Branch at 0x7fbaeabdd3d0&gt;}
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">last_state</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="s2">&quot;model_0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">coords</span>

<span class="c1"># same as</span>
<span class="c1"># last_state.branches_coords[&quot;model_0&quot;]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([[[[ 0.78336101, -0.50304083, -0.16554043,  0.38717246,
          -0.53567929]],

        [[ 1.67992539,  0.45789611,  0.71044046,  0.99561671,
          -0.18785587]],

        [[ 1.58942687, -0.98468048, -0.23409897, -0.34754982,
           0.5749637 ]],

        [[-1.51043746,  1.46761376, -1.36652826,  0.13575554,
           1.58616381]],

        [[ 0.56687718, -0.71412812, -1.07272873,  0.90290266,
          -0.9749437 ]],

        [[-0.26148892, -0.32754323,  2.05336273,  0.43505825,
           1.23267062]],

        [[-0.11388586,  0.97965383,  1.18803374, -0.55536628,
           0.50140833]],

        [[ 0.97231495, -1.80168105, -0.87750463,  0.55941876,
           0.9055604 ]],

        [[ 0.93206222,  0.61099548,  0.22893838, -0.06397951,
           2.53085973]],

        [[ 1.78123828,  0.29397075,  0.87720694, -0.51235873,
          -0.87712242]],

        [[-0.0915609 , -0.06094217,  0.39300579,  0.27838045,
          -1.6473782 ]],

        [[ 0.6848448 ,  0.37394608,  0.43214013,  0.80375073,
          -0.62217316]],

        [[ 1.78087387, -0.37379556, -1.70695828,  0.98429392,
          -1.46919589]],

        [[ 0.87912662,  0.80736483,  2.84535279, -1.02691072,
          -1.61697279]],

        [[-1.59413254, -1.14139239, -0.70216385,  0.56814835,
           1.23763059]],

        [[-1.8783785 , -0.93419666,  0.25561706, -0.41370698,
          -0.03998814]],

        [[-0.43668379, -0.39311608, -0.07642243,  2.43586086,
           0.97223065]],

        [[ 0.00745957, -0.21236731,  0.23184676,  0.8907263 ,
           1.16475211]],

        [[-1.7308126 ,  0.62439654,  0.69996634,  0.52028448,
          -0.43853217]],

        [[-2.30865891,  0.92696939, -0.98209765,  0.4834703 ,
          -1.30722477]],

        [[ 2.07144626, -0.56432505, -0.29089771,  1.32751881,
           2.1210728 ]],

        [[ 0.25274812,  0.9270326 , -0.58971747,  0.75561133,
           1.33792123]],

        [[ 0.05336995, -1.51405245,  0.06533858, -0.93630816,
          -1.40238616]],

        [[ 0.10136621, -1.01709496,  0.08910818, -0.52223649,
           2.2454308 ]],

        [[-0.86197169,  3.73127788,  1.07000261, -0.29443113,
          -0.40651963]],

        [[-1.81087754, -1.31763714,  1.12761906, -0.55144102,
          -1.21964748]],

        [[ 0.72082232, -0.66783269, -0.61110439, -0.05759876,
          -1.18926752]],

        [[-0.31039828, -0.84006455, -0.7555078 , -0.88418758,
           0.82023276]],

        [[-1.15032279, -1.28216431,  0.19945317,  0.9670416 ,
          -0.37643346]],

        [[-0.20656978, -1.09247869, -0.83026592, -0.29333812,
          -2.54354725]],

        [[ 0.0506733 ,  1.58235446, -1.0591977 , -0.01318246,
          -0.08567564]],

        [[ 1.00402466, -1.09280401, -0.57272931, -0.10612996,
          -0.56686201]],

        [[ 0.63470563, -0.29598879,  0.03616789,  1.20713821,
          -0.3009565 ]],

        [[ 0.69564655,  0.26928194,  1.15389273,  0.12383051,
           0.51493035]],

        [[-1.79119556,  0.69120098,  0.01019032, -1.21449347,
           1.19529285]],

        [[ 0.39078543,  1.32386668,  1.4771604 ,  0.02665296,
          -0.27157202]],

        [[ 1.66344411,  1.40855699, -0.2227286 , -0.03021349,
           1.12585205]],

        [[ 0.0358304 ,  0.67413575, -0.6791267 , -0.17160254,
           1.00517803]],

        [[-0.66454531,  0.44931894,  1.2731242 ,  0.80140622,
           0.09520302]],

        [[ 0.08417592, -0.2045363 , -0.81677496,  0.60685038,
           0.11358217]],

        [[-0.41939285,  0.56655054, -0.45246425,  0.12320174,
          -0.25527187]],

        [[ 0.02585738,  1.4670955 ,  0.71912218,  0.7720434 ,
          -0.05341122]],

        [[ 1.29611737,  0.1748023 ,  0.4372776 , -0.68897449,
          -1.3131327 ]],

        [[ 0.24317085,  0.05633037,  0.50847769, -1.16816417,
          -0.76160903]],

        [[-0.43456796,  0.81744538,  0.64783055,  1.33848598,
          -1.09218265]],

        [[-0.19003503,  1.0901105 , -1.68079509, -0.42874181,
           1.48445254]],

        [[-0.09533596,  1.1585624 , -0.28324105,  1.41256148,
          -0.93230171]],

        [[ 0.30259333, -1.2291636 ,  1.14969874,  1.02255485,
          -0.58419916]],

        [[-0.4221966 ,  0.85477946,  0.25227351,  0.96312104,
          -1.39770535]],

        [[-1.0401763 ,  0.6414978 ,  0.55821906, -0.14829119,
          -1.47269454]],

        [[-0.10152982,  0.38256367,  0.08807142,  0.43429676,
           0.59181726]],

        [[ 0.05120369, -0.77512143,  1.14463123, -0.23983033,
           0.67143671]],

        [[ 1.50082842, -0.30584941,  0.20683388, -0.03483413,
           0.20720856]],

        [[-1.08598898,  0.22080208, -0.64865562,  0.40682697,
           0.70122139]],

        [[-0.64175924, -1.58143259,  0.89952925,  1.54536517,
          -0.86749033]],

        [[ 1.06019685, -0.04449809,  1.47050671,  1.04282887,
          -2.24454869]],

        [[ 1.32891118,  0.38437228, -0.71091403, -0.65667314,
           0.11566271]],

        [[-1.52706537,  0.56474267, -0.76715602, -2.42312996,
           0.76080056]],

        [[-1.67036294, -0.28564342, -0.21110799, -0.14839688,
          -1.05283774]],

        [[ 0.05478405, -0.08082125,  0.1447414 , -1.98462828,
           0.42112513]],

        [[-1.21974939, -1.10592271,  1.67658838, -0.49570422,
           0.45793154]],

        [[-1.02752867, -0.5590723 , -0.54126603, -0.48664511,
          -0.43764875]],

        [[ 0.66773172,  0.82481843, -0.15349943,  2.88049842,
          -0.28931849]],

        [[-1.31243376,  1.3452211 ,  0.40682334,  0.18493076,
           0.04839187]],

        [[ 0.50253895,  0.19130782,  0.11088476,  0.56778619,
          -1.36271421]],

        [[ 0.5242914 , -0.99162198,  0.9547818 ,  0.25692932,
          -0.89856378]],

        [[ 0.15281554,  0.77735714, -1.11311344, -0.01051167,
           0.02134045]],

        [[ 0.06119311,  1.17510522, -0.52670296, -0.42278451,
          -0.60418234]],

        [[ 0.24963427,  1.1611201 ,  1.10664802, -0.70071643,
          -0.51691024]],

        [[ 0.89998806, -0.3590725 , -0.0173904 ,  0.94144735,
           0.37182924]],

        [[ 1.37866043, -1.28597385, -0.24976022,  0.42612563,
           2.82950074]],

        [[ 1.72487348, -0.00682858, -1.25268318,  1.29240179,
           0.68332019]],

        [[-0.05155055, -1.9316834 ,  0.34874628, -0.4050601 ,
           0.47131539]],

        [[-0.68665177, -1.32277562,  1.62515034, -1.04049481,
           0.59094657]],

        [[ 0.29061988,  0.28060227,  0.45655932, -0.60961052,
           0.12862806]],

        [[-1.0491748 , -0.19942752, -0.27318093,  0.79095823,
          -1.06471564]],

        [[-1.32490203, -2.01371249, -0.69586741, -0.07780255,
           0.08082376]],

        [[ 0.902882  , -0.40395368, -0.57161503, -0.6188732 ,
           0.79434534]],

        [[ 1.33174975, -0.08962046, -0.40607314,  1.28465644,
          -0.0654673 ]],

        [[ 0.99906271, -1.14535375, -0.31550719,  0.49069006,
          -0.73052807]],

        [[-1.31724964,  0.01639082, -0.97773904,  1.77949826,
           0.90806883]],

        [[ 0.60840415,  0.35765918,  1.09470711,  0.24921034,
           0.98871092]],

        [[ 1.15249127, -1.04587488,  0.68114623, -0.44485005,
           0.97479187]],

        [[-0.41527236,  1.18904736, -1.55784624, -1.77663656,
           0.06626997]],

        [[-0.69748913,  0.91203846,  0.65645409,  0.67068651,
           1.56675987]],

        [[ 0.13570414,  0.561949  , -0.00650889,  2.20041901,
          -0.01172908]],

        [[ 0.006941  , -1.27228794, -0.85989137,  1.46663793,
          -0.96448725]],

        [[-1.49410352, -0.02103752, -0.89929408,  0.99124781,
          -0.28788692]],

        [[ 1.21738227, -0.20578794,  0.62613854, -0.54711243,
          -0.45468127]],

        [[-1.35998576,  0.23620079,  0.19631993,  0.81886101,
          -0.23891811]],

        [[-0.32009865, -0.99200186, -0.58326714,  1.2244503 ,
          -0.61884746]],

        [[ 0.30593953, -0.54655862, -1.54046119,  0.45128582,
          -0.63043325]],

        [[ 0.92726937,  0.10223362,  0.89663029,  0.12669414,
           0.63684452]],

        [[-0.74616171,  0.41006412, -0.4589307 ,  0.09501266,
          -1.15033712]],

        [[ 0.21188577, -0.69703418,  0.09822929,  1.27225746,
           1.57391104]],

        [[-0.3775653 ,  1.3247288 , -1.12052205, -0.0951038 ,
          -1.32710163]],

        [[-2.55808909,  0.61767066,  0.28774531,  1.08037741,
           1.42380889]],

        [[-0.05488234,  1.12340336,  0.8862303 , -0.52472562,
           0.9497435 ]],

        [[-0.35200129,  0.36531645,  0.22484955,  1.08386021,
           0.83386291]],

        [[-1.83839054,  0.67436706, -0.56586041,  0.24858485,
           0.2514738 ]]]])
</pre></div></div>
</div>
</section>
</section>
<section id="Parallel-Tempering">
<h2>Parallel Tempering<a class="headerlink" href="#Parallel-Tempering" title="Permalink to this headline">¶</a></h2>
<p>Adding tempering to our problem is straight forward. It will effectively just take the <code class="docutils literal notranslate"><span class="pre">ntemps</span></code> dimension that was 1 above and stretch it to the number of temperatures desired. We add tempering information by providing the <code class="docutils literal notranslate"><span class="pre">tempering_kwargs</span></code> argument to the <code class="docutils literal notranslate"><span class="pre">EnsembleSampler</span></code>. The tempering kwargs documentation can be found here because they are the <code class="docutils literal notranslate"><span class="pre">kwargs</span></code> that go into the initialization of the temperature controller:
<code class="docutils literal notranslate"><span class="pre">`eryn.moves.tempering.TemperatureControl</span></code> &lt;<a class="reference external" href="https://mikekatz04.github.io/Eryn/html/user/temper.html#eryn.moves.tempering.TemperatureControl">https://mikekatz04.github.io/Eryn/html/user/temper.html#eryn.moves.tempering.TemperatureControl</a>&gt;`__.</p>
<p>The simplest thing to do is to provide the number of temperatures. In this case, we just pass <code class="docutils literal notranslate"><span class="pre">ntemps</span></code> in a dictionary. You can also provide a direct array of <code class="docutils literal notranslate"><span class="pre">betas</span></code> (inverse temperatures). Under the hood, if only <code class="docutils literal notranslate"><span class="pre">ntemps</span></code> is passed (not <code class="docutils literal notranslate"><span class="pre">betas</span></code>), the sampler will use the <code class="docutils literal notranslate"><span class="pre">`eryn.moves.tempering.make_ladder</span></code> &lt;<a class="reference external" href="https://mikekatz04.github.io/Eryn/html/user/temper.html#eryn.moves.tempering.make_ladder">https://mikekatz04.github.io/Eryn/html/user/temper.html#eryn.moves.tempering.make_ladder</a>&gt;`__ function. We will go all thr way through to the MCMC run. Notice that we are once
again just passing <code class="docutils literal notranslate"><span class="pre">coords</span></code> as an array to start the sampling. We could also pass a <code class="docutils literal notranslate"><span class="pre">State</span></code> object.</p>
<p>What does tempering actual do? The inverse temperature, <span class="math notranslate nohighlight">\(\beta=1/T\)</span>, is attached as an exponent on the Likelihood. The posterior probability as a function of inverse temperature is given by,</p>
<div class="math notranslate nohighlight">
\[\pi_\beta(\vec{\theta}, \mathcal{M})\propto (\mathcal{L}(\vec{\theta}, \mathcal{M}))^\beta p(\vec{\theta},\mathcal{M}).\]</div>
<p>If <span class="math notranslate nohighlight">\(T=1\rightarrow \beta=1\)</span>, we are probing our TARGET distribution.</p>
<p>If <span class="math notranslate nohighlight">\(T=\infty\rightarrow \beta=0\)</span>, we are probing the PRIOR distribution. In this case, the Likelihood surface is effectively flat.</p>
<p>Temperatures in between represent the gradual flattening of the target Likelihood surface towards the flat surface at infinite temperature. During sampling, we look at the log of the Likelihood, so the inverse temperature becomes a multiplicative factor:</p>
<div class="math notranslate nohighlight">
\[\ln\pi_\beta(\vec{\theta}, \mathcal{M})\propto\beta\ln\mathcal{L}(\vec{\theta}, \mathcal{M})\]</div>
<p>Tempering is useful for multimodal distributions and to improve mixing in your chains. This mixing is created by swapping between rungs on our temperature ladder. After each sampler step, swaps are proposed starting at the two highest temperatures and iterating down until we reach the two lowest temperatures. This ensures as higher temperature chains find better Likelihood values, these values and positions are passed toward the cold chain (<span class="math notranslate nohighlight">\(\beta=1\)</span>). The swaps between chains are accepted
with fraction, <span class="math notranslate nohighlight">\(\alpha_T\)</span>:</p>
<div class="math notranslate nohighlight">
\[\alpha_T = \min\left(1, \left[\frac{\mathcal{L_{\beta_1}}}{\mathcal{L_{\beta_2}}}\right]^{\beta_1 - \beta_2}\right).\]</div>
<p>We can see from this how swapping is similar to the Metropolis-Hastings acceptance setup.If <span class="math notranslate nohighlight">\(\beta_1 &gt; \beta_2\)</span> (or <span class="math notranslate nohighlight">\(T_1 &lt;T_2\)</span>), the exponent is positive. In this case, if <span class="math notranslate nohighlight">\(\mathcal{L_{\beta_1}} &gt; \mathcal{L_{\beta_2}}\)</span>, the swap will always be accepted because we want the better likelihood to go to higher <span class="math notranslate nohighlight">\(\beta\)</span> (or lower <span class="math notranslate nohighlight">\(T\)</span>). If <span class="math notranslate nohighlight">\(\mathcal{L_{\beta_1}} &lt; \mathcal{L_{\beta_2}}\)</span>, the swap is accepted with a probability that reflects difference in the
Likelihoods just like discussed above.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>

<span></span><span class="c1"># set up problem</span>
<span class="n">ndim</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">nwalkers</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">ntemps</span> <span class="o">=</span> <span class="mi">10</span>

<span class="c1"># fill kwargs dictionary</span>
<span class="n">tempering_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">ntemps</span><span class="o">=</span><span class="n">ntemps</span><span class="p">)</span>

<span class="c1"># randomize throughout prior</span>
<span class="n">coords</span> <span class="o">=</span> <span class="n">priors</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">,))</span>

<span class="c1"># initialize sampler</span>
<span class="n">ensemble_pt</span> <span class="o">=</span> <span class="n">EnsembleSampler</span><span class="p">(</span>
    <span class="n">nwalkers</span><span class="p">,</span>
    <span class="n">ndim</span><span class="p">,</span>
    <span class="n">log_like_fn</span><span class="p">,</span>
    <span class="n">priors</span><span class="p">,</span>
    <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">means</span><span class="p">,</span> <span class="n">cov</span><span class="p">],</span>
    <span class="n">tempering_kwargs</span><span class="o">=</span><span class="n">tempering_kwargs</span>
<span class="p">)</span>

<span class="n">nsteps</span> <span class="o">=</span> <span class="mi">500</span>
<span class="c1"># burn for 1000 steps</span>
<span class="n">burn</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="c1"># thin by 5</span>
<span class="n">thin_by</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">ensemble_pt</span><span class="o">.</span><span class="n">run_mcmc</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">nsteps</span><span class="p">,</span> <span class="n">burn</span><span class="o">=</span><span class="n">burn</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">thin_by</span><span class="o">=</span><span class="n">thin_by</span><span class="p">)</span>


</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|██████████| 1000/1000 [00:06&lt;00:00, 145.07it/s]
100%|██████████| 2500/2500 [00:18&lt;00:00, 138.46it/s]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;eryn.state.State at 0x7fbad8ac7fa0&gt;
</pre></div></div>
</div>
<p>We can plot our samples at different temperatures and see the differences in action.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">c</span> <span class="o">=</span> <span class="n">ChainConsumer</span><span class="p">()</span>
<span class="n">c</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">shade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shade_alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">bar_shade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">usetex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">colors</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">magma</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">ntemps</span><span class="p">))</span>

<span class="k">for</span> <span class="n">temp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntemps</span><span class="p">):</span>

    <span class="n">samples</span> <span class="o">=</span> <span class="n">ensemble_pt</span><span class="o">.</span><span class="n">get_chain</span><span class="p">()[</span><span class="s1">&#39;model_0&#39;</span><span class="p">][:,</span> <span class="n">temp</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ndim</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">add_chain</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;$x_</span><span class="si">{}</span><span class="s2">$&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">temp</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;$T_</span><span class="si">{}</span><span class="s2">$&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">temp</span><span class="p">))</span>

<span class="n">c</span><span class="o">.</span><span class="n">plotter</span><span class="o">.</span><span class="n">plot_distributions</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">12</span><span class="p">),</span> <span class="n">truth</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">ndim</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">));</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;text.usetex&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">True</span> <span class="c1"># Update this becasue chaincnsumer is annoying</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING:chainconsumer:Configure has been called 2 times - this is not good - it should be once!
WARNING:chainconsumer:To avoid this, load your chains in first, then call analysis/plotting methods
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_49_1.png" src="../_images/tutorial_Eryn_tutorial_49_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#### Chains</span>
<span class="k">for</span> <span class="n">temp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ntemps</span><span class="p">):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ndim</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">13</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">walk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nwalkers</span><span class="p">):</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ensemble_pt</span><span class="o">.</span><span class="n">get_chain</span><span class="p">()[</span><span class="s1">&#39;model_0&#39;</span><span class="p">][:,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">walk</span><span class="p">,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_50_0.png" src="../_images/tutorial_Eryn_tutorial_50_0.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_50_1.png" src="../_images/tutorial_Eryn_tutorial_50_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_50_2.png" src="../_images/tutorial_Eryn_tutorial_50_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_50_3.png" src="../_images/tutorial_Eryn_tutorial_50_3.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_50_4.png" src="../_images/tutorial_Eryn_tutorial_50_4.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_50_5.png" src="../_images/tutorial_Eryn_tutorial_50_5.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_50_6.png" src="../_images/tutorial_Eryn_tutorial_50_6.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_50_7.png" src="../_images/tutorial_Eryn_tutorial_50_7.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_50_8.png" src="../_images/tutorial_Eryn_tutorial_50_8.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_50_9.png" src="../_images/tutorial_Eryn_tutorial_50_9.png" />
</div>
</div>
<p>Likelihoods across temperatures:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ll</span> <span class="o">=</span> <span class="n">ensemble_pt</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">get_log_like</span><span class="p">()</span>

<span class="c1"># cold chain and highest temperature chain</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ll</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Cold&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;lightskyblue&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ll</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Warm&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Samples&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;$\log\mathcal</span><span class="si">{L}</span><span class="s2">$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_52_0.png" src="../_images/tutorial_Eryn_tutorial_52_0.png" />
</div>
</div>
</section>
<section id="Add-Reversible-Jump-MCMC-(model-count-uncertainty)">
<h2>Add Reversible Jump MCMC (model count uncertainty)<a class="headerlink" href="#Add-Reversible-Jump-MCMC-(model-count-uncertainty)" title="Permalink to this headline">¶</a></h2>
<p>We will now add to our sampler the ability to run with one branch, but a variable number of counts or leaves.</p>
<p>Here we are going to focus on the nested model case where we are just proposing changes in the model count. For more general review on Reversible Jump, see the Eryn paper and sources within.</p>
<p>In nested models, the acceptance probability for proposing to add a source is given by, <span class="math notranslate nohighlight">\(\alpha_\text{nested}\)</span>,</p>
<div class="math notranslate nohighlight">
\[\alpha_\text{nested} = \min\left(1, \frac{\mathcal{L}(\vec{\theta})_{k+1}}{\mathcal{L}(\vec{\theta})_{k}}\frac{p(\vec{\theta}_{+1})}{q(\vec{\theta}_{+1})}\right),\]</div>
<p>where there are <span class="math notranslate nohighlight">\(k\)</span> models to start, <span class="math notranslate nohighlight">\(p(\vec{\theta}_{+1})\)</span> is the prior probability of the added source only (the prior of the other sources cancels in the numerator and denominator), and <span class="math notranslate nohighlight">\(q(\vec{\theta}_{+1})\)</span> is the proposal distribution for the added source, <span class="math notranslate nohighlight">\(\mathcal{L}(\vec{\theta})_k\)</span> is the Likelihood for the position with <span class="math notranslate nohighlight">\(k\)</span> models, and <span class="math notranslate nohighlight">\(\mathcal{L}(\vec{\theta})_{k+1}\)</span> is the Likelihood for the position with <span class="math notranslate nohighlight">\(k + 1\)</span> models.</p>
<p>Reversible Jump proposals usually require specific implementations for each problem. We have one provided RJ proposal where we draw from the prior, which is the simplest and most generic reversible jump proposal for adding a nested model. In this case, the acceptance fraction just reduces to the Likelihood fraction.</p>
<p>For this example, we will look at a set of 1D Gaussian pulses. We will inject a specific number, and then allow the sampler to determine the posterior probability on the model count, as well as the posterior on the parameters.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">gaussian_pulse</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="n">f_x</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">c</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">f_x</span>

<span class="k">def</span> <span class="nf">combine_gaussians</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
        <span class="n">template</span> <span class="o">+=</span> <span class="n">gaussian_pulse</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>  <span class="c1"># *params -&gt; a, b, c</span>
    <span class="k">return</span> <span class="n">template</span>

<span class="k">def</span> <span class="nf">log_like_fn_gauss_pulse</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>

    <span class="n">template</span> <span class="o">=</span> <span class="n">combine_gaussians</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

    <span class="n">ll</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(((</span><span class="n">template</span> <span class="o">-</span> <span class="n">data</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ll</span>


<span class="n">nwalkers</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">ntemps</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">ndim</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">nleaves_max</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">nleaves_min</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">branch_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">]</span>

<span class="c1"># define time stream</span>
<span class="n">num</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>

<span class="n">gauss_inj_params</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="mf">3.3</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">2.6</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">3.4</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">2.9</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
<span class="p">]</span>

<span class="c1"># combine gaussians</span>
<span class="n">injection</span> <span class="o">=</span> <span class="n">combine_gaussians</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">gauss_inj_params</span><span class="p">))</span>

<span class="c1"># set noise level</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mf">2.0</span>

<span class="c1"># produce full data</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">injection</span> <span class="o">+</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">injection</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;lightskyblue&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">injection</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;injection&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;crimson&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$x$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;$y$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x7fbaeced2730&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_56_1.png" src="../_images/tutorial_Eryn_tutorial_56_1.png" />
</div>
</div>
<p>The first thing we do is setup our <code class="docutils literal notranslate"><span class="pre">coords</span></code> array. We have seen <code class="docutils literal notranslate"><span class="pre">coords</span></code> before. That array is the same but now <code class="docutils literal notranslate"><span class="pre">nleaves_max</span> <span class="pre">&gt;</span> <span class="pre">1</span></code>.</p>
<p>We also need to setup our <code class="docutils literal notranslate"><span class="pre">inds</span></code> arrays. <code class="docutils literal notranslate"><span class="pre">inds</span></code> is only needed when the dimensionality is changing (or more generally when not all leaves are used). <code class="docutils literal notranslate"><span class="pre">inds</span></code> is a boolean array with shape <code class="docutils literal notranslate"><span class="pre">(ntemps,</span> <span class="pre">nwalkers,</span> <span class="pre">nleaves_max)</span></code>. It indicates which leaves are being used. This allows us to use the array structures while have a variable number of leaves per walker.</p>
<p>We are going to assume we have some knowledge of what is in the data, so we are going to start with 4 leaves for every walker. The burn-in will spread out the walkers both in terms of the parameters and in terms of the number of leaves per walker. Therefore, we are going to make the first four leaves in every walker <code class="docutils literal notranslate"><span class="pre">True</span></code> to indicate 4 sources. We are going to then put coordinates near each of the true Gaussians into <code class="docutils literal notranslate"><span class="pre">coords</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">coords</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gauss&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">,</span> <span class="n">nleaves_max</span><span class="p">,</span> <span class="n">ndim</span><span class="p">))}</span>

<span class="c1"># this is the sigma for the multivariate Gaussian that sets starting points</span>
<span class="c1"># We need it to be very small to assume we are passed the search phase</span>
<span class="c1"># we will verify this is with likelihood calculations</span>
<span class="n">sig1</span> <span class="o">=</span> <span class="mf">0.0001</span>

<span class="c1"># setup initial walkers to be the correct count (it will spread out)</span>
<span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nleaves_max</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">nn</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gauss_inj_params</span><span class="p">):</span>
        <span class="c1"># not going to add parameters for these unused leaves</span>
        <span class="k">continue</span>

    <span class="n">coords</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">nn</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">gauss_inj_params</span><span class="p">[</span><span class="n">nn</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">sig1</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">))</span>

<span class="c1"># make sure to start near the proper setup</span>
<span class="n">inds</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gauss&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">,</span> <span class="n">nleaves_max</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)}</span>

<span class="c1"># turn False -&gt; True for any binary in the sampler</span>
<span class="n">inds</span><span class="p">[</span><span class="s1">&#39;gauss&#39;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">gauss_inj_params</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
</div>
<p>Priors are defined per model for a single model. It will take into account multiple models by summing the prior probability over the leaves.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># describes priors for all leaves independently</span>
<span class="n">priors</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;gauss&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="mi">0</span><span class="p">:</span> <span class="n">uniform_dist</span><span class="p">(</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">),</span>  <span class="c1"># amplitude</span>
        <span class="mi">1</span><span class="p">:</span> <span class="n">uniform_dist</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">t</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>  <span class="c1"># mean</span>
        <span class="mi">2</span><span class="p">:</span> <span class="n">uniform_dist</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.21</span><span class="p">),</span>  <span class="c1"># sigma</span>
    <span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>When reversible jump sampling is run, an RJ move (between model) is performed followed by an “in-model” move for each iteration of the sampler. “In-model” here means the model count is fixed, but the parameters are updated. We pass “in-model” moves to the sampler with the keyword argument <code class="docutils literal notranslate"><span class="pre">moves</span></code>. We pass RJ moves with the <code class="docutils literal notranslate"><span class="pre">rj_moves</span></code> keyword argument.</p>
<p>The stock proposal in <code class="docutils literal notranslate"><span class="pre">Eryn</span></code> is the stretch proposal. This proposal is only directly useful when the dimensionality is fixed. This will be discussed more below. When using reversible jump, we must choose our in-model proposal because the dimensionality is not fixed. Therefore, we choose to move our walkers with the most basic in-model move available: <code class="docutils literal notranslate"><span class="pre">`eryn.moves.GaussianMove</span></code> &lt;<a class="reference external" href="https://mikekatz04.github.io/Eryn/html/user/moves.html#eryn.moves.GaussianMove">https://mikekatz04.github.io/Eryn/html/user/moves.html#eryn.moves.GaussianMove</a>&gt;`__. For this move you can provide a
covariance matrix that will be used in a multivariate Gaussian to propose new points that are centered on the current points (the means of the multivariate Gaussian will be the current point). This proposal is symmetric.</p>
<p>In this case, we are going to use the stock RJ proposal: <code class="docutils literal notranslate"><span class="pre">`eryn.moves.PriorGenRj</span></code> &lt;<a class="reference external" href="https://mikekatz04.github.io/Eryn/html/user/moves.html#eryn.moves.DistributionGenerateRJ">https://mikekatz04.github.io/Eryn/html/user/moves.html#eryn.moves.DistributionGenerateRJ</a>&gt;`__. You can either pass this directly or you can set <code class="docutils literal notranslate"><span class="pre">rj_moves</span></code> to <code class="docutils literal notranslate"><span class="pre">True</span></code> (this is the default).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># for the Gaussian Move, will be explained later</span>
<span class="n">factor</span> <span class="o">=</span> <span class="mf">0.00001</span>
<span class="n">cov</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gauss&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ndim</span><span class="p">))</span> <span class="o">*</span> <span class="n">factor</span><span class="p">}</span>

<span class="n">moves</span> <span class="o">=</span> <span class="n">GaussianMove</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>

</pre></div>
</div>
</div>
<p>We will now initialize the sampler by adding the branch, tempering, leaf, and move information.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ensemble</span> <span class="o">=</span> <span class="n">EnsembleSampler</span><span class="p">(</span>
    <span class="n">nwalkers</span><span class="p">,</span>
    <span class="n">ndim</span><span class="p">,</span>
    <span class="n">log_like_fn_gauss_pulse</span><span class="p">,</span>
    <span class="n">priors</span><span class="p">,</span>
    <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sigma</span><span class="p">],</span>
    <span class="n">tempering_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">ntemps</span><span class="o">=</span><span class="n">ntemps</span><span class="p">),</span>
    <span class="n">nbranches</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">branch_names</span><span class="p">),</span>
    <span class="n">branch_names</span><span class="o">=</span><span class="n">branch_names</span><span class="p">,</span>
    <span class="n">nleaves_max</span><span class="o">=</span><span class="n">nleaves_max</span><span class="p">,</span>
    <span class="n">nleaves_min</span><span class="o">=</span><span class="n">nleaves_min</span><span class="p">,</span>
    <span class="n">moves</span><span class="o">=</span><span class="n">moves</span><span class="p">,</span>
    <span class="n">rj_moves</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># basic generation of new leaves from the prior</span>
<span class="p">)</span>


</pre></div>
</div>
</div>
<p>Now we will setup a <code class="docutils literal notranslate"><span class="pre">State</span></code> object and will use the Likelihood (<code class="docutils literal notranslate"><span class="pre">compute_log_like</span></code>) and prior functions (<code class="docutils literal notranslate"><span class="pre">compute_log_prior</span></code>) that are built into the sampler. The Likelihood function in the sampler will check the prior and only run walkers that exist entirely within the prior distribution. We can avoid redoing this computation by passing the prior as the <code class="docutils literal notranslate"><span class="pre">logp</span></code> kwarg to <code class="docutils literal notranslate"><span class="pre">compute_log_like</span></code>. The <code class="docutils literal notranslate"><span class="pre">[0]</span></code> at the end of the line is to grab the log Likelihood and leave behind any blobs.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>

<span></span><span class="n">log_prior</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">compute_log_prior</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="n">inds</span><span class="p">)</span>
<span class="n">log_like</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">compute_log_like</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="n">inds</span><span class="p">,</span> <span class="n">logp</span><span class="o">=</span><span class="n">log_prior</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># make sure it is reasonably close to the maximum which this is</span>
<span class="c1"># will not be zero due to noise</span>
<span class="nb">print</span><span class="p">(</span><span class="n">log_like</span><span class="p">,</span> <span class="n">log_prior</span><span class="p">)</span>

<span class="c1"># setup starting state</span>
<span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">log_like</span><span class="o">=</span><span class="n">log_like</span><span class="p">,</span> <span class="n">log_prior</span><span class="o">=</span><span class="n">log_prior</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="n">inds</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[-267.48857258 -273.13358068 -272.04356318 -273.41959181 -269.65159976
  -273.45581292 -269.0534354  -269.21480317 -270.17335397 -268.79114293
  -267.97593006 -269.76118281 -268.97477874 -268.96915067 -267.44497304
  -268.55232307 -268.69079155 -269.13611008 -266.317588   -268.19035794]
 [-267.89498107 -271.07519263 -271.01364247 -269.87074404 -271.04982746
  -273.10216287 -270.47561552 -268.73825004 -268.55984235 -267.59669384
  -269.1644275  -268.17686823 -269.5530668  -266.38471516 -270.13810357
  -268.4965744  -271.16336376 -268.37273575 -269.78843561 -266.07926996]
 [-266.65635127 -268.4524668  -269.58696913 -269.88671242 -266.37498437
  -266.44936502 -266.4546787  -272.25432486 -269.746439   -273.53395912
  -268.78432036 -268.09641939 -269.51993913 -270.03690593 -268.47293353
  -270.13166208 -267.3654575  -272.4533991  -267.76589766 -268.67119754]
 [-268.70301053 -268.05419472 -266.85429247 -268.34706671 -272.61170665
  -270.35744037 -267.49130951 -266.41191836 -275.34555909 -267.63796847
  -268.91668611 -268.75395295 -265.89682062 -265.78621765 -269.99614319
  -266.0744601  -267.66910539 -271.02551726 -268.96820568 -272.10089077]
 [-269.36015159 -267.91718124 -266.58033431 -270.98339743 -271.82208208
  -271.73487149 -269.30751278 -269.16895186 -266.30161    -272.80287899
  -269.03261838 -269.48740534 -270.6325905  -267.60035469 -268.2688322
  -274.62821662 -266.26778016 -267.04032577 -270.28884496 -269.45920218]
 [-267.25519775 -267.62892664 -272.26285005 -267.00766373 -269.57983127
  -274.27398717 -268.46784025 -271.09344272 -271.24621424 -267.80982016
  -273.18463057 -268.36312445 -270.59373649 -270.557759   -271.87911261
  -266.02454376 -266.93381068 -278.98378996 -269.83416176 -268.05726244]
 [-267.02005355 -268.09999743 -269.06119558 -268.00971489 -268.12141711
  -268.14986569 -268.14312728 -267.72178265 -271.78486633 -270.33369975
  -268.45148378 -269.87881376 -268.72205688 -270.82850441 -267.57604611
  -266.79122124 -267.35162949 -267.59266883 -267.114322   -270.56048742]
 [-267.67914435 -266.02251242 -266.32624169 -269.16921554 -268.73743926
  -274.21583965 -269.74454528 -269.21673563 -268.68519371 -266.60927311
  -270.20377505 -267.99209023 -269.13139001 -268.27709924 -265.67000643
  -274.6973296  -269.6495672  -269.3549933  -269.01571009 -267.5950623 ]] [[3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293]
 [3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293]
 [3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293]
 [3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293]
 [3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293]
 [3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293]
 [3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293]
 [3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293 3.66516293 3.66516293 3.66516293 3.66516293
  3.66516293 3.66516293]]
</pre></div></div>
</div>
<p>Run the sampler</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">nsteps</span> <span class="o">=</span> <span class="mi">2000</span>
<span class="n">last_sample</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">run_mcmc</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">nsteps</span><span class="p">,</span> <span class="n">burn</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">thin_by</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
 48%|████▊     | 478/1000 [00:08&lt;00:09, 57.05it/s]Traceback (most recent call last):
  File &#34;/Users/nikos/work/programs/anaconda3/lib/python3.9/site-packages/eryn/ensemble.py&#34;, line 1430, in __call__
    out = self.f(*args_in, **kwargs_in)
  File &#34;/var/folders/yz/xf637mpx56g2dvdv9d8v1fnm0000gn/T/ipykernel_80778/341605811.py&#34;, line 13, in log_like_fn_gauss_pulse
    template = combine_gaussians(t, params)
  File &#34;/var/folders/yz/xf637mpx56g2dvdv9d8v1fnm0000gn/T/ipykernel_80778/341605811.py&#34;, line 8, in combine_gaussians
    template += gaussian_pulse(t, *param)  # *params -&gt; a, b, c
  File &#34;/var/folders/yz/xf637mpx56g2dvdv9d8v1fnm0000gn/T/ipykernel_80778/341605811.py&#34;, line 2, in gaussian_pulse
    f_x = a * np.exp(-((x - b) ** 2) / (2 * c ** 2))
KeyboardInterrupt
 48%|████▊     | 480/1000 [00:08&lt;00:09, 56.01it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
eryn: Exception while calling your likelihood function:
  args added: [array([[ 3.20995857, -0.09259871,  0.13038718]])]
  args: [array([-1.        , -0.99599198, -0.99198397, -0.98797595, -0.98396794,
       -0.97995992, -0.9759519 , -0.97194389, -0.96793587, -0.96392786,
       -0.95991984, -0.95591182, -0.95190381, -0.94789579, -0.94388778,
       -0.93987976, -0.93587174, -0.93186373, -0.92785571, -0.9238477 ,
       -0.91983968, -0.91583166, -0.91182365, -0.90781563, -0.90380762,
       -0.8997996 , -0.89579158, -0.89178357, -0.88777555, -0.88376754,
       -0.87975952, -0.8757515 , -0.87174349, -0.86773547, -0.86372745,
       -0.85971944, -0.85571142, -0.85170341, -0.84769539, -0.84368737,
       -0.83967936, -0.83567134, -0.83166333, -0.82765531, -0.82364729,
       -0.81963928, -0.81563126, -0.81162325, -0.80761523, -0.80360721,
       -0.7995992 , -0.79559118, -0.79158317, -0.78757515, -0.78356713,
       -0.77955912, -0.7755511 , -0.77154309, -0.76753507, -0.76352705,
       -0.75951904, -0.75551102, -0.75150301, -0.74749499, -0.74348697,
       -0.73947896, -0.73547094, -0.73146293, -0.72745491, -0.72344689,
       -0.71943888, -0.71543086, -0.71142285, -0.70741483, -0.70340681,
       -0.6993988 , -0.69539078, -0.69138277, -0.68737475, -0.68336673,
       -0.67935872, -0.6753507 , -0.67134269, -0.66733467, -0.66332665,
       -0.65931864, -0.65531062, -0.65130261, -0.64729459, -0.64328657,
       -0.63927856, -0.63527054, -0.63126253, -0.62725451, -0.62324649,
       -0.61923848, -0.61523046, -0.61122244, -0.60721443, -0.60320641,
       -0.5991984 , -0.59519038, -0.59118236, -0.58717435, -0.58316633,
       -0.57915832, -0.5751503 , -0.57114228, -0.56713427, -0.56312625,
       -0.55911824, -0.55511022, -0.5511022 , -0.54709419, -0.54308617,
       -0.53907816, -0.53507014, -0.53106212, -0.52705411, -0.52304609,
       -0.51903808, -0.51503006, -0.51102204, -0.50701403, -0.50300601,
       -0.498998  , -0.49498998, -0.49098196, -0.48697395, -0.48296593,
       -0.47895792, -0.4749499 , -0.47094188, -0.46693387, -0.46292585,
       -0.45891784, -0.45490982, -0.4509018 , -0.44689379, -0.44288577,
       -0.43887776, -0.43486974, -0.43086172, -0.42685371, -0.42284569,
       -0.41883768, -0.41482966, -0.41082164, -0.40681363, -0.40280561,
       -0.3987976 , -0.39478958, -0.39078156, -0.38677355, -0.38276553,
       -0.37875752, -0.3747495 , -0.37074148, -0.36673347, -0.36272545,
       -0.35871743, -0.35470942, -0.3507014 , -0.34669339, -0.34268537,
       -0.33867735, -0.33466934, -0.33066132, -0.32665331, -0.32264529,
       -0.31863727, -0.31462926, -0.31062124, -0.30661323, -0.30260521,
       -0.29859719, -0.29458918, -0.29058116, -0.28657315, -0.28256513,
       -0.27855711, -0.2745491 , -0.27054108, -0.26653307, -0.26252505,
       -0.25851703, -0.25450902, -0.250501  , -0.24649299, -0.24248497,
       -0.23847695, -0.23446894, -0.23046092, -0.22645291, -0.22244489,
       -0.21843687, -0.21442886, -0.21042084, -0.20641283, -0.20240481,
       -0.19839679, -0.19438878, -0.19038076, -0.18637275, -0.18236473,
       -0.17835671, -0.1743487 , -0.17034068, -0.16633267, -0.16232465,
       -0.15831663, -0.15430862, -0.1503006 , -0.14629259, -0.14228457,
       -0.13827655, -0.13426854, -0.13026052, -0.12625251, -0.12224449,
       -0.11823647, -0.11422846, -0.11022044, -0.10621242, -0.10220441,
       -0.09819639, -0.09418838, -0.09018036, -0.08617234, -0.08216433,
       -0.07815631, -0.0741483 , -0.07014028, -0.06613226, -0.06212425,
       -0.05811623, -0.05410822, -0.0501002 , -0.04609218, -0.04208417,
       -0.03807615, -0.03406814, -0.03006012, -0.0260521 , -0.02204409,
       -0.01803607, -0.01402806, -0.01002004, -0.00601202, -0.00200401,
        0.00200401,  0.00601202,  0.01002004,  0.01402806,  0.01803607,
        0.02204409,  0.0260521 ,  0.03006012,  0.03406814,  0.03807615,
        0.04208417,  0.04609218,  0.0501002 ,  0.05410822,  0.05811623,
        0.06212425,  0.06613226,  0.07014028,  0.0741483 ,  0.07815631,
        0.08216433,  0.08617234,  0.09018036,  0.09418838,  0.09819639,
        0.10220441,  0.10621242,  0.11022044,  0.11422846,  0.11823647,
        0.12224449,  0.12625251,  0.13026052,  0.13426854,  0.13827655,
        0.14228457,  0.14629259,  0.1503006 ,  0.15430862,  0.15831663,
        0.16232465,  0.16633267,  0.17034068,  0.1743487 ,  0.17835671,
        0.18236473,  0.18637275,  0.19038076,  0.19438878,  0.19839679,
        0.20240481,  0.20641283,  0.21042084,  0.21442886,  0.21843687,
        0.22244489,  0.22645291,  0.23046092,  0.23446894,  0.23847695,
        0.24248497,  0.24649299,  0.250501  ,  0.25450902,  0.25851703,
        0.26252505,  0.26653307,  0.27054108,  0.2745491 ,  0.27855711,
        0.28256513,  0.28657315,  0.29058116,  0.29458918,  0.29859719,
        0.30260521,  0.30661323,  0.31062124,  0.31462926,  0.31863727,
        0.32264529,  0.32665331,  0.33066132,  0.33466934,  0.33867735,
        0.34268537,  0.34669339,  0.3507014 ,  0.35470942,  0.35871743,
        0.36272545,  0.36673347,  0.37074148,  0.3747495 ,  0.37875752,
        0.38276553,  0.38677355,  0.39078156,  0.39478958,  0.3987976 ,
        0.40280561,  0.40681363,  0.41082164,  0.41482966,  0.41883768,
        0.42284569,  0.42685371,  0.43086172,  0.43486974,  0.43887776,
        0.44288577,  0.44689379,  0.4509018 ,  0.45490982,  0.45891784,
        0.46292585,  0.46693387,  0.47094188,  0.4749499 ,  0.47895792,
        0.48296593,  0.48697395,  0.49098196,  0.49498998,  0.498998  ,
        0.50300601,  0.50701403,  0.51102204,  0.51503006,  0.51903808,
        0.52304609,  0.52705411,  0.53106212,  0.53507014,  0.53907816,
        0.54308617,  0.54709419,  0.5511022 ,  0.55511022,  0.55911824,
        0.56312625,  0.56713427,  0.57114228,  0.5751503 ,  0.57915832,
        0.58316633,  0.58717435,  0.59118236,  0.59519038,  0.5991984 ,
        0.60320641,  0.60721443,  0.61122244,  0.61523046,  0.61923848,
        0.62324649,  0.62725451,  0.63126253,  0.63527054,  0.63927856,
        0.64328657,  0.64729459,  0.65130261,  0.65531062,  0.65931864,
        0.66332665,  0.66733467,  0.67134269,  0.6753507 ,  0.67935872,
        0.68336673,  0.68737475,  0.69138277,  0.69539078,  0.6993988 ,
        0.70340681,  0.70741483,  0.71142285,  0.71543086,  0.71943888,
        0.72344689,  0.72745491,  0.73146293,  0.73547094,  0.73947896,
        0.74348697,  0.74749499,  0.75150301,  0.75551102,  0.75951904,
        0.76352705,  0.76753507,  0.77154309,  0.7755511 ,  0.77955912,
        0.78356713,  0.78757515,  0.79158317,  0.79559118,  0.7995992 ,
        0.80360721,  0.80761523,  0.81162325,  0.81563126,  0.81963928,
        0.82364729,  0.82765531,  0.83166333,  0.83567134,  0.83967936,
        0.84368737,  0.84769539,  0.85170341,  0.85571142,  0.85971944,
        0.86372745,  0.86773547,  0.87174349,  0.8757515 ,  0.87975952,
        0.88376754,  0.88777555,  0.89178357,  0.89579158,  0.8997996 ,
        0.90380762,  0.90781563,  0.91182365,  0.91583166,  0.91983968,
        0.9238477 ,  0.92785571,  0.93186373,  0.93587174,  0.93987976,
        0.94388778,  0.94789579,  0.95190381,  0.95591182,  0.95991984,
        0.96392786,  0.96793587,  0.97194389,  0.9759519 ,  0.97995992,
        0.98396794,  0.98797595,  0.99198397,  0.99599198,  1.        ]), array([-0.12880248,  1.44923933,  1.73112544, -0.78408063,  1.49904876,
       -4.72554155,  2.63463266,  4.40491724, -0.39779605, -1.5328282 ,
        2.31851763, -0.29219376,  0.62197099,  0.39459965, -3.74532572,
       -4.06071758,  1.38274957,  1.45761118, -2.12867757,  1.14660787,
        1.74782894, -0.05233179, -0.40410896, -0.49223034,  2.5061968 ,
        0.24944957,  0.41576225, -1.15915196,  1.70366446, -2.05767594,
        1.35371516,  0.15078536, -1.41011843,  0.40341553,  1.50884972,
        2.49121137, -0.66499659,  0.06199744,  2.89327043, -3.61179312,
       -0.19820038,  1.36886803,  3.26317029,  4.28523331, -1.06399121,
        4.64816525, -1.00141394, -3.123858  ,  0.5850514 ,  0.3243589 ,
       -0.19769128, -0.58894659, -2.70662136,  0.65300534,  1.14941697,
        1.0186292 , -1.0441261 ,  2.71215165, -0.14582838, -0.11858425,
        0.36995325,  1.99553768,  1.07598195,  1.59982504,  0.76410262,
        1.32524587, -1.69163154, -2.55381651, -0.35512489,  2.65374588,
       -2.95741653,  2.01777869, -1.91203485,  2.09086898,  0.29219706,
       -3.58446802, -3.02882   , -1.02517939,  0.64606147,  4.95512533,
        0.42277843,  4.47816304, -0.57669691,  1.04839993, -1.82771043,
       -0.05584083,  0.48939983,  0.59944365, -2.11839599, -3.80720401,
       -2.80056758, -2.0207498 , -0.35646447,  1.66695795,  1.6538429 ,
       -1.15257628,  0.11924907,  2.38316971, -2.21302598, -0.03800048,
       -2.57856783, -1.81611747,  1.37372872, -3.74473807, -0.11413861,
       -3.18651589,  2.38306061, -2.6709282 ,  0.33818096, -0.31487831,
       -2.07944139,  0.26843456, -0.4684186 , -2.18955102,  1.57107786,
        1.54215186,  1.20042304,  0.13195051,  0.42544909,  0.78597788,
       -0.5118935 ,  2.27119743, -1.89074922,  0.32412011, -0.09963454,
       -1.28073506,  1.1894806 ,  0.7697442 ,  2.81843954, -3.50431928,
       -2.73914708,  0.42834279,  1.31480927,  2.19610841,  4.40962086,
       -1.57205323,  0.2523447 , -0.20031547,  2.63739156, -0.85703307,
        0.18515983, -1.06231236,  0.05704266, -2.60462803,  0.46397872,
        1.16088779,  0.87752548, -0.18951593,  1.74352978, -0.65867519,
       -0.94669362,  0.42140799,  5.8197349 ,  0.11633146,  3.4661335 ,
        1.21690197,  2.551786  , -0.31901963,  1.82817754,  2.23955995,
       -1.5019571 , -2.0734359 , -1.30906454,  1.95483552,  2.10188268,
        0.18425391,  1.51749939, -0.22577467,  2.00285713,  0.6522392 ,
        0.5702404 ,  3.04588582,  1.85785476,  1.27945357,  4.138804  ,
        3.52904542,  1.45055085,  2.82203515,  2.69766892,  3.85860284,
        3.15369685,  2.48228114,  3.1552369 ,  0.67977171,  0.78085036,
        4.10080922,  5.67521154,  7.05181478,  8.34992543,  4.9559213 ,
        0.88017795,  4.32775897,  6.67090655,  7.82270854, 10.27504076,
        8.12891394,  4.79396331,  2.10432798,  4.897646  ,  8.83036868,
        3.50143023,  3.13480305,  2.57527389,  3.53264137,  9.84148724,
        6.33863537,  7.19668191,  2.85974484,  7.27516718,  5.33270041,
        3.18834222,  6.73197548,  3.44390807,  6.58296534,  6.63536819,
        3.756704  ,  8.3636637 ,  7.92568469,  4.52789701,  8.60353654,
        8.37068592,  8.11504764,  5.93243803,  6.24789357,  4.28471329,
        4.9744506 ,  7.65011436,  6.55831974,  7.11754729,  8.7289761 ,
        3.78841441,  8.97193234,  7.00240341,  4.08060638,  3.93406264,
        7.18469838,  4.1025531 ,  8.54927533,  5.1341838 ,  7.2933789 ,
        4.77986892,  4.84869469,  2.2986912 ,  7.2036628 ,  3.73211798,
        8.04582529,  7.58210118, 10.01590682,  2.63530092,  7.90205697,
        4.76194068,  8.86560358,  2.3769534 , 10.67509792,  5.19816747,
        5.06216993,  4.30670168,  4.32617567,  3.29228446,  2.14147209,
        8.50873288,  5.7684928 ,  5.44257284,  7.50270752,  3.24838431,
        1.53653918,  4.65793315,  3.93067869,  3.16959151,  2.21830547,
        0.030198  ,  3.67441974,  1.43371779,  4.04056242,  3.98734168,
        0.20663327,  5.65425105,  2.11168036,  3.75738194,  0.71585124,
        2.44057715,  2.09299313,  0.96721123,  4.77321943,  1.00042948,
        3.62742566,  2.80527576,  2.90885958,  5.33874732,  2.59710958,
        0.57828456,  2.23658211,  3.55941092, -1.48942592, -1.2201898 ,
        0.94037593, -2.75751687,  1.27799407,  0.50439477,  0.70300747,
        3.0125368 ,  0.95595812, -1.08653603,  3.99448707,  1.1311912 ,
       -0.08117009,  3.01840298,  3.40154435,  5.38739644,  0.5393623 ,
        1.79835956, -3.30741714,  1.98420909,  7.81777625,  7.03980004,
        1.43027906,  5.37518236,  2.88885895, -1.49977432,  4.0069099 ,
        1.577538  ,  4.40430252,  6.53202337,  2.10162115,  1.52049744,
        7.44199647,  4.56857931,  3.91133735,  2.85989237,  4.07298082,
        2.84777205,  3.43622158,  1.63982256,  1.48134045,  4.31570824,
        4.23678188,  1.91498697, -0.10344975, -0.60295307,  5.50065782,
       -0.34430368,  1.70048166, -1.51890495,  6.48723393,  2.30166491,
        4.95098762,  4.53068715,  1.8197459 ,  4.2114549 ,  3.61035183,
        0.61236645, -0.42535586,  1.24142385,  2.71935428,  1.80055933,
       -2.67337736,  2.23403883,  1.01936899,  0.35801591, -0.3007015 ,
        0.39653515,  0.16795555,  2.0150017 ,  0.03716724, -0.20607378,
        1.64139986, -1.70017936,  0.66381071,  2.00486173, -2.55660853,
        1.45543436, -2.19916868,  3.82023053,  4.26984264, -0.62713135,
        3.16749739,  3.27748838, -1.60488756, -0.29141416, -0.18836515,
       -0.10615471,  2.33080576,  1.69802099,  1.70784841,  2.62964503,
        1.46027794,  1.4697797 ,  0.58993777,  2.2651347 ,  0.96462875,
        0.03105987,  1.06927301,  0.1021301 , -1.93254695, -4.33240542,
        2.24266735,  0.16508126, -3.04917727, -2.40231007, -2.92055392,
        0.25757479, -1.55492433, -2.03683842,  0.64594334, -1.22925677,
        1.98413094,  1.68076735, -0.93843488,  1.14472159,  1.11381353,
        2.49263731, -1.14178517, -2.38911425,  0.87140273, -0.3606307 ,
        1.98487698, -2.98166139, -0.10857798,  0.73232612,  0.58486937,
       -3.43790136, -1.04107702, -5.27357253,  0.25564649, -0.98116148,
        0.74077384, -0.95881488,  4.37283808,  1.12883178, -0.08518031,
       -0.65211873, -0.57578769,  2.34614929, -3.89607911, -0.41947646,
        0.19577319, -0.9452825 , -1.11018596, -2.35527449,  0.53647928,
        0.24365902,  2.76065601, -1.28833897,  0.52394655, -0.97565735,
        2.64075889,  0.07933557,  1.42214671,  0.70443701,  0.52975271,
        2.02476889,  1.43412018, -0.01564917,  2.76753234,  0.58213234,
        0.34125365, -0.50527549, -1.30466801, -4.22363985,  3.2998344 ,
       -3.14078225,  3.74631785, -1.18823195,  0.3828145 ,  3.53834511,
       -0.99393952,  1.80847444,  1.49031649,  2.69988064, -0.45857568,
       -2.07816851, -1.75456563, -2.20492744,  2.34599102, -1.23395798,
        7.67958295, -0.98292243,  0.92867119,  1.48020527,  1.50144232,
       -1.37570327, -1.76831655, -2.27539937,  0.25857213, -1.38535678,
        1.13718794, -0.55042315,  0.8062337 , -0.82720735, -0.25713643,
       -2.73053437,  0.15237057, -4.48386125, -0.36949233, -4.98589283,
        1.70228891,  0.20092129, -1.15169219, -3.72249707,  1.59575827]), 2.0]
  kwargs added: {}
  kwargs: {}
  exception:
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">KeyboardInterrupt</span>                         Traceback (most recent call last)
<span class="ansi-green-fg">/var/folders/yz/xf637mpx56g2dvdv9d8v1fnm0000gn/T/ipykernel_80778/2560070696.py</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">      1</span> nsteps <span class="ansi-blue-fg">=</span> <span class="ansi-cyan-fg">2000</span>
<span class="ansi-green-fg">----&gt; 2</span><span class="ansi-red-fg"> </span>last_sample <span class="ansi-blue-fg">=</span> ensemble<span class="ansi-blue-fg">.</span>run_mcmc<span class="ansi-blue-fg">(</span>state<span class="ansi-blue-fg">,</span> nsteps<span class="ansi-blue-fg">,</span> burn<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">1000</span><span class="ansi-blue-fg">,</span> progress<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">,</span> thin_by<span class="ansi-blue-fg">=</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/work/programs/anaconda3/lib/python3.9/site-packages/eryn/ensemble.py</span> in <span class="ansi-cyan-fg">run_mcmc</span><span class="ansi-blue-fg">(self, initial_state, nsteps, burn, post_burn_update, **kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">    857</span>             burn_kwargs<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">&#34;thin_by&#34;</span><span class="ansi-blue-fg">]</span> <span class="ansi-blue-fg">=</span> <span class="ansi-cyan-fg">1</span>
<span class="ansi-green-intense-fg ansi-bold">    858</span>             i <span class="ansi-blue-fg">=</span> <span class="ansi-cyan-fg">0</span>
<span class="ansi-green-fg">--&gt; 859</span><span class="ansi-red-fg">             </span><span class="ansi-green-fg">for</span> results <span class="ansi-green-fg">in</span> self<span class="ansi-blue-fg">.</span>sample<span class="ansi-blue-fg">(</span>initial_state<span class="ansi-blue-fg">,</span> iterations<span class="ansi-blue-fg">=</span>burn<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>burn_kwargs<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">    860</span>                 <span class="ansi-red-fg"># if updating and using burn_in, need to make sure it does not use</span>
<span class="ansi-green-intense-fg ansi-bold">    861</span>                 <span class="ansi-red-fg"># previous chain samples since they are not stored.</span>

<span class="ansi-green-fg">~/work/programs/anaconda3/lib/python3.9/site-packages/eryn/ensemble.py</span> in <span class="ansi-cyan-fg">sample</span><span class="ansi-blue-fg">(self, initial_state, iterations, tune, skip_initial_state_check, thin_by, store, progress)</span>
<span class="ansi-green-intense-fg ansi-bold">    753</span>
<span class="ansi-green-intense-fg ansi-bold">    754</span>                         <span class="ansi-red-fg"># Propose (in model)</span>
<span class="ansi-green-fg">--&gt; 755</span><span class="ansi-red-fg">                         </span>state<span class="ansi-blue-fg">,</span> accepted_out <span class="ansi-blue-fg">=</span> move<span class="ansi-blue-fg">.</span>propose<span class="ansi-blue-fg">(</span>model<span class="ansi-blue-fg">,</span> state<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">    756</span>                         accepted <span class="ansi-blue-fg">+=</span> accepted_out
<span class="ansi-green-intense-fg ansi-bold">    757</span>                         <span class="ansi-green-fg">if</span> self<span class="ansi-blue-fg">.</span>ntemps <span class="ansi-blue-fg">&gt;</span> <span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">:</span>

<span class="ansi-green-fg">~/work/programs/anaconda3/lib/python3.9/site-packages/eryn/moves/mh.py</span> in <span class="ansi-cyan-fg">propose</span><span class="ansi-blue-fg">(self, model, state)</span>
<span class="ansi-green-intense-fg ansi-bold">    115</span>             <span class="ansi-red-fg"># Compute the lnprobs of the proposed position.</span>
<span class="ansi-green-intense-fg ansi-bold">    116</span>             <span class="ansi-red-fg"># Can adjust supplimentals in place</span>
<span class="ansi-green-fg">--&gt; 117</span><span class="ansi-red-fg">             logl, new_blobs = model.compute_log_like_fn(
</span><span class="ansi-green-intense-fg ansi-bold">    118</span>                 q<span class="ansi-blue-fg">,</span>
<span class="ansi-green-intense-fg ansi-bold">    119</span>                 inds<span class="ansi-blue-fg">=</span>state<span class="ansi-blue-fg">.</span>branches_inds<span class="ansi-blue-fg">,</span>

<span class="ansi-green-fg">~/work/programs/anaconda3/lib/python3.9/site-packages/eryn/ensemble.py</span> in <span class="ansi-cyan-fg">compute_log_like</span><span class="ansi-blue-fg">(self, coords, inds, logp, supps, branch_supps)</span>
<span class="ansi-green-intense-fg ansi-bold">   1258</span>
<span class="ansi-green-intense-fg ansi-bold">   1259</span>             <span class="ansi-red-fg"># get results and turn into an array</span>
<span class="ansi-green-fg">-&gt; 1260</span><span class="ansi-red-fg">             </span>results <span class="ansi-blue-fg">=</span> np<span class="ansi-blue-fg">.</span>asarray<span class="ansi-blue-fg">(</span>list<span class="ansi-blue-fg">(</span>map_func<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>log_like_fn<span class="ansi-blue-fg">,</span> args_in<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   1261</span>
<span class="ansi-green-intense-fg ansi-bold">   1262</span>         <span class="ansi-green-fg">assert</span> isinstance<span class="ansi-blue-fg">(</span>results<span class="ansi-blue-fg">,</span> np<span class="ansi-blue-fg">.</span>ndarray<span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">~/work/programs/anaconda3/lib/python3.9/site-packages/eryn/ensemble.py</span> in <span class="ansi-cyan-fg">__call__</span><span class="ansi-blue-fg">(self, args_and_kwargs)</span>
<span class="ansi-green-intense-fg ansi-bold">   1428</span>             <span class="ansi-red-fg"># TODO: this may have pickle issue with multiprocessing (kwargs_in)</span>
<span class="ansi-green-intense-fg ansi-bold">   1429</span>
<span class="ansi-green-fg">-&gt; 1430</span><span class="ansi-red-fg">             </span>out <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>f<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">*</span>args_in<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwargs_in<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">   1431</span>             <span class="ansi-green-fg">return</span> out
<span class="ansi-green-intense-fg ansi-bold">   1432</span>

<span class="ansi-green-fg">/var/folders/yz/xf637mpx56g2dvdv9d8v1fnm0000gn/T/ipykernel_80778/341605811.py</span> in <span class="ansi-cyan-fg">log_like_fn_gauss_pulse</span><span class="ansi-blue-fg">(params, t, data, sigma)</span>
<span class="ansi-green-intense-fg ansi-bold">     11</span> <span class="ansi-green-fg">def</span> log_like_fn_gauss_pulse<span class="ansi-blue-fg">(</span>params<span class="ansi-blue-fg">,</span> t<span class="ansi-blue-fg">,</span> data<span class="ansi-blue-fg">,</span> sigma<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-intense-fg ansi-bold">     12</span>
<span class="ansi-green-fg">---&gt; 13</span><span class="ansi-red-fg">     </span>template <span class="ansi-blue-fg">=</span> combine_gaussians<span class="ansi-blue-fg">(</span>t<span class="ansi-blue-fg">,</span> params<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     14</span>
<span class="ansi-green-intense-fg ansi-bold">     15</span>     ll <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">-</span><span class="ansi-cyan-fg">0.5</span> <span class="ansi-blue-fg">*</span> np<span class="ansi-blue-fg">.</span>sum<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">(</span>template <span class="ansi-blue-fg">-</span> data<span class="ansi-blue-fg">)</span> <span class="ansi-blue-fg">/</span> sigma<span class="ansi-blue-fg">)</span> <span class="ansi-blue-fg">**</span> <span class="ansi-cyan-fg">2</span><span class="ansi-blue-fg">,</span> axis<span class="ansi-blue-fg">=</span><span class="ansi-blue-fg">-</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">/var/folders/yz/xf637mpx56g2dvdv9d8v1fnm0000gn/T/ipykernel_80778/341605811.py</span> in <span class="ansi-cyan-fg">combine_gaussians</span><span class="ansi-blue-fg">(t, params)</span>
<span class="ansi-green-intense-fg ansi-bold">      6</span>     template <span class="ansi-blue-fg">=</span> np<span class="ansi-blue-fg">.</span>zeros_like<span class="ansi-blue-fg">(</span>t<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">      7</span>     <span class="ansi-green-fg">for</span> param <span class="ansi-green-fg">in</span> params<span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">----&gt; 8</span><span class="ansi-red-fg">         </span>template <span class="ansi-blue-fg">+=</span> gaussian_pulse<span class="ansi-blue-fg">(</span>t<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">*</span>param<span class="ansi-blue-fg">)</span>  <span class="ansi-red-fg"># *params -&gt; a, b, c</span>
<span class="ansi-green-intense-fg ansi-bold">      9</span>     <span class="ansi-green-fg">return</span> template
<span class="ansi-green-intense-fg ansi-bold">     10</span>

<span class="ansi-green-fg">/var/folders/yz/xf637mpx56g2dvdv9d8v1fnm0000gn/T/ipykernel_80778/341605811.py</span> in <span class="ansi-cyan-fg">gaussian_pulse</span><span class="ansi-blue-fg">(x, a, b, c)</span>
<span class="ansi-green-intense-fg ansi-bold">      1</span> <span class="ansi-green-fg">def</span> gaussian_pulse<span class="ansi-blue-fg">(</span>x<span class="ansi-blue-fg">,</span> a<span class="ansi-blue-fg">,</span> b<span class="ansi-blue-fg">,</span> c<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">----&gt; 2</span><span class="ansi-red-fg">     </span>f_x <span class="ansi-blue-fg">=</span> a <span class="ansi-blue-fg">*</span> np<span class="ansi-blue-fg">.</span>exp<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">-</span><span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">(</span>x <span class="ansi-blue-fg">-</span> b<span class="ansi-blue-fg">)</span> <span class="ansi-blue-fg">**</span> <span class="ansi-cyan-fg">2</span><span class="ansi-blue-fg">)</span> <span class="ansi-blue-fg">/</span> <span class="ansi-blue-fg">(</span><span class="ansi-cyan-fg">2</span> <span class="ansi-blue-fg">*</span> c <span class="ansi-blue-fg">**</span> <span class="ansi-cyan-fg">2</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">      3</span>     <span class="ansi-green-fg">return</span> f_x
<span class="ansi-green-intense-fg ansi-bold">      4</span>
<span class="ansi-green-intense-fg ansi-bold">      5</span> <span class="ansi-green-fg">def</span> combine_gaussians<span class="ansi-blue-fg">(</span>t<span class="ansi-blue-fg">,</span> params<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>

<span class="ansi-red-fg">KeyboardInterrupt</span>:
</pre></div></div>
</div>
<p>Let’s look at the last sample in terms of the <code class="docutils literal notranslate"><span class="pre">nleaves</span></code> array.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">last_sample</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nleaves</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([[4, 5, 4, 4, 5, 4, 3, 4, 4, 5, 4, 3, 4, 5, 4, 3, 4, 4, 4, 4],
       [3, 4, 3, 3, 4, 4, 3, 4, 3, 4, 5, 5, 3, 4, 3, 3, 4, 3, 4, 4],
       [3, 3, 3, 5, 3, 3, 4, 4, 4, 5, 3, 3, 4, 4, 3, 4, 3, 3, 3, 3],
       [2, 3, 3, 4, 3, 4, 4, 4, 3, 4, 3, 3, 4, 4, 4, 4, 3, 2, 3, 4],
       [5, 2, 4, 4, 3, 2, 3, 3, 3, 3, 4, 4, 2, 4, 5, 3, 3, 3, 4, 2],
       [3, 3, 4, 3, 6, 3, 3, 4, 3, 3, 5, 3, 3, 4, 3, 4, 5, 3, 3, 2],
       [2, 2, 2, 5, 2, 4, 3, 2, 2, 5, 4, 4, 6, 6, 3, 3, 1, 3, 4, 3],
       [1, 6, 2, 4, 7, 7, 5, 3, 1, 6, 2, 7, 1, 2, 3, 5, 3, 3, 6, 6]])
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;max ll: </span><span class="si">{</span><span class="n">ensemble</span><span class="o">.</span><span class="n">get_log_like</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">nleaves</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">get_nleaves</span><span class="p">()[</span><span class="s1">&#39;gauss&#39;</span><span class="p">]</span>
<span class="n">bns</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nleaves_max</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span>
<span class="p">)</span>  <span class="c1"># Just to make it pretty and center the bins</span>

<span class="n">colors</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">magma</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">ntemps</span><span class="p">))</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ntemps</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
<span class="k">for</span> <span class="n">temp</span><span class="p">,</span> <span class="n">ax_t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ax</span><span class="p">):</span>
    <span class="n">ax_t</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">nleaves</span><span class="p">[:,</span> <span class="n">temp</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">bins</span><span class="o">=</span><span class="n">bns</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">temp</span><span class="p">],</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax_t</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Order $k$ of model&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
max ll: -261.23462233367997
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_72_1.png" src="../_images/tutorial_Eryn_tutorial_72_1.png" />
</div>
</div>
<p>To get the samples, we need remove any sources that were not used. We can combine <code class="docutils literal notranslate"><span class="pre">coords</span></code> and <code class="docutils literal notranslate"><span class="pre">inds</span></code> or we can remove anywhere where the backend returns <code class="docutils literal notranslate"><span class="pre">Nan</span></code>. Backends store <code class="docutils literal notranslate"><span class="pre">Nan</span></code> for the coordinates that belong to sources that are not currently used (<code class="docutils literal notranslate"><span class="pre">inds</span> <span class="pre">==</span> <span class="pre">False</span></code>).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">samples</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">get_chain</span><span class="p">()[</span><span class="s1">&#39;gauss&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ndim</span><span class="p">)</span>

<span class="c1"># same as ensemble.get_chain()[&#39;gauss&#39;][ensemble.get_inds()[&#39;gauss&#39;]]</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">samples</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])]</span>

<span class="n">means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">gauss_inj_params</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>

<span class="n">param_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;$A$&#39;</span><span class="p">,</span> <span class="s1">&#39;$\mu$&#39;</span><span class="p">,</span> <span class="s1">&#39;$\sigma$&#39;</span><span class="p">]</span>

<span class="n">c</span> <span class="o">=</span> <span class="n">ChainConsumer</span><span class="p">()</span>
<span class="n">c</span><span class="o">.</span><span class="n">add_chain</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">param_names</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#6495ed&#39;</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">shade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shade_alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">bar_shade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">usetex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">serif</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gauss_inj_params</span><span class="p">)):</span>
    <span class="n">c</span><span class="o">.</span><span class="n">add_marker</span><span class="p">(</span><span class="n">gauss_inj_params</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">parameters</span><span class="o">=</span><span class="n">param_names</span><span class="p">,</span> <span class="n">marker_style</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">marker_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#DC143C&#39;</span><span class="p">)</span>

<span class="n">c</span><span class="o">.</span><span class="n">plotter</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">);</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;text.usetex&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">True</span> <span class="c1"># Update this becasue chaincnsumer is annoying</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_74_0.png" src="../_images/tutorial_Eryn_tutorial_74_0.png" />
</div>
</div>
</section>
<section id="Add-multiple-branches">
<h2>Add multiple branches<a class="headerlink" href="#Add-multiple-branches" title="Permalink to this headline">¶</a></h2>
<p>Now we will add another model to our reversible jump problem. We will add a sine wave model.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">gaussian_pulse</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="n">f_x</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">c</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">f_x</span>

<span class="k">def</span> <span class="nf">combine_gaussians</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
        <span class="n">template</span> <span class="o">+=</span> <span class="n">gaussian_pulse</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>  <span class="c1"># *params -&gt; a, b, c</span>
    <span class="k">return</span> <span class="n">template</span>

<span class="k">def</span> <span class="nf">sine</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="n">f_x</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">b</span> <span class="o">*</span> <span class="n">x</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">f_x</span>

<span class="k">def</span> <span class="nf">combine_sine</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
        <span class="n">template</span> <span class="o">+=</span> <span class="n">sine</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>  <span class="c1"># *params -&gt; a, b, c</span>
    <span class="k">return</span> <span class="n">template</span>

<span class="k">def</span> <span class="nf">log_like_fn_gauss_and_sine</span><span class="p">(</span><span class="n">params_both</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>

    <span class="n">params_gauss</span><span class="p">,</span> <span class="n">params_sine</span> <span class="o">=</span> <span class="n">params_both</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">params_gauss</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">template</span> <span class="o">+=</span> <span class="n">combine_gaussians</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">params_gauss</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">params_sine</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">template</span> <span class="o">+=</span> <span class="n">combine_sine</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">params_sine</span><span class="p">)</span>

    <span class="n">ll</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(((</span><span class="n">template</span> <span class="o">-</span> <span class="n">data</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ll</span>


<span class="n">nwalkers</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">ntemps</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">ndims</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">nleaves_max</span> <span class="o">=</span> <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
<span class="n">nleaves_min</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>

<span class="n">branch_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">,</span> <span class="s2">&quot;sine&quot;</span><span class="p">]</span>

<span class="c1"># define time stream</span>
<span class="n">num</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>

<span class="n">gauss_inj_params</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="mf">3.3</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">2.6</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">3.4</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">2.9</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
<span class="p">]</span>

<span class="n">sine_inj_params</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">[</span><span class="mf">1.3</span><span class="p">,</span> <span class="mf">10.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
    <span class="p">[</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">4.6</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">],</span>
<span class="p">]</span>

<span class="c1"># combine gaussians</span>
<span class="n">injection</span> <span class="o">=</span> <span class="n">combine_gaussians</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">gauss_inj_params</span><span class="p">))</span>
<span class="n">injection</span> <span class="o">+=</span> <span class="n">combine_sine</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">sine_inj_params</span><span class="p">))</span>

<span class="c1"># set noise level</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mf">2.0</span>

<span class="c1"># produce full data</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">injection</span> <span class="o">+</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">injection</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;lightskyblue&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">injection</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;injection&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;crimson&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$x$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;$y$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x169a6a6a0&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_77_1.png" src="../_images/tutorial_Eryn_tutorial_77_1.png" />
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">coords</span></code> and <code class="docutils literal notranslate"><span class="pre">inds</span></code></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">coords</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;gauss&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">,</span> <span class="n">nleaves_max</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ndims</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span>
    <span class="s2">&quot;sine&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">,</span> <span class="n">nleaves_max</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ndims</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="p">}</span>

<span class="c1"># make sure to start near the proper setup</span>
<span class="n">inds</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;gauss&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">,</span> <span class="n">nleaves_max</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">),</span>
    <span class="s2">&quot;sine&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">,</span> <span class="n">nleaves_max</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
<span class="p">}</span>


<span class="c1"># this is the sigma for the multivariate Gaussian that sets starting points</span>
<span class="c1"># We need it to be very small to assume we are passed the search phase</span>
<span class="c1"># we will verify this is with likelihood calculations</span>
<span class="n">sig1</span> <span class="o">=</span> <span class="mf">0.0001</span>

<span class="c1"># setup initial walkers to be the correct count (it will spread out)</span>
<span class="c1"># start with gaussians</span>
<span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nleaves_max</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="k">if</span> <span class="n">nn</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gauss_inj_params</span><span class="p">):</span>
        <span class="c1"># not going to add parameters for these unused leaves</span>
        <span class="k">continue</span>
    <span class="n">coords</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">nn</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">gauss_inj_params</span><span class="p">[</span><span class="n">nn</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">sig1</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">))</span>
    <span class="n">inds</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">nn</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

<span class="c1"># next do sine waves</span>
<span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nleaves_max</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="k">if</span> <span class="n">nn</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sine_inj_params</span><span class="p">):</span>
        <span class="c1"># not going to add parameters for these unused leaves</span>
        <span class="k">continue</span>
    <span class="n">coords</span><span class="p">[</span><span class="s2">&quot;sine&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">nn</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">sine_inj_params</span><span class="p">[</span><span class="n">nn</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">sig1</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">))</span>
    <span class="n">inds</span><span class="p">[</span><span class="s2">&quot;sine&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">nn</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

</pre></div>
</div>
</div>
<p>Priors are defined per model for a single model. It will take into account multiple models by summing the prior probability over the leaves.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># describes priors for all leaves independently</span>
<span class="n">priors</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;gauss&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="mi">0</span><span class="p">:</span> <span class="n">uniform_dist</span><span class="p">(</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">),</span>  <span class="c1"># amplitude</span>
        <span class="mi">1</span><span class="p">:</span> <span class="n">uniform_dist</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">t</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>  <span class="c1"># mean</span>
        <span class="mi">2</span><span class="p">:</span> <span class="n">uniform_dist</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.21</span><span class="p">),</span>  <span class="c1"># sigma</span>
    <span class="p">},</span>
    <span class="s2">&quot;sine&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="mi">0</span><span class="p">:</span> <span class="n">uniform_dist</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">),</span>  <span class="c1"># amplitude</span>
        <span class="mi">1</span><span class="p">:</span> <span class="n">uniform_dist</span><span class="p">(</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">20.</span><span class="p">),</span>  <span class="c1"># mean</span>
        <span class="mi">2</span><span class="p">:</span> <span class="n">uniform_dist</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>  <span class="c1"># sigma</span>
    <span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>You can add multiple covariance matrices. One for each branch. We will keep it the same for simplicity.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># for the Gaussian Move, will be explained later</span>
<span class="n">factor</span> <span class="o">=</span> <span class="mf">0.00001</span>
<span class="n">cov</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;gauss&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ndims</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">*</span> <span class="n">factor</span><span class="p">,</span>
    <span class="s2">&quot;sine&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ndims</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">*</span> <span class="n">factor</span>
<span class="p">}</span>

<span class="n">moves</span> <span class="o">=</span> <span class="n">GaussianMove</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>

</pre></div>
</div>
</div>
<p>We will now initialize the sampler by adding the branch, tempering, leaf, and move information.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ensemble</span> <span class="o">=</span> <span class="n">EnsembleSampler</span><span class="p">(</span>
    <span class="n">nwalkers</span><span class="p">,</span>
    <span class="n">ndims</span><span class="p">,</span>
    <span class="n">log_like_fn_gauss_and_sine</span><span class="p">,</span>
    <span class="n">priors</span><span class="p">,</span>
    <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sigma</span><span class="p">],</span>
    <span class="n">tempering_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">ntemps</span><span class="o">=</span><span class="n">ntemps</span><span class="p">),</span>
    <span class="n">nbranches</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">branch_names</span><span class="p">),</span>
    <span class="n">branch_names</span><span class="o">=</span><span class="n">branch_names</span><span class="p">,</span>
    <span class="n">nleaves_max</span><span class="o">=</span><span class="n">nleaves_max</span><span class="p">,</span>
    <span class="n">nleaves_min</span><span class="o">=</span><span class="n">nleaves_min</span><span class="p">,</span>
    <span class="n">moves</span><span class="o">=</span><span class="n">moves</span><span class="p">,</span>
    <span class="n">rj_moves</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># basic generation of new leaves from the prior</span>
<span class="p">)</span>


</pre></div>
</div>
</div>
<p>Prior, Likelihood, and initial state.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>

<span></span><span class="n">log_prior</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">compute_log_prior</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="n">inds</span><span class="p">)</span>
<span class="n">log_like</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">compute_log_like</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="n">inds</span><span class="p">,</span> <span class="n">logp</span><span class="o">=</span><span class="n">log_prior</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># make sure it is reasonably close to the maximum which this is</span>
<span class="c1"># will not be zero due to noise</span>
<span class="nb">print</span><span class="p">(</span><span class="n">log_like</span><span class="p">,</span> <span class="n">log_prior</span><span class="p">)</span>

<span class="c1"># setup starting state</span>
<span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">log_like</span><span class="o">=</span><span class="n">log_like</span><span class="p">,</span> <span class="n">log_prior</span><span class="o">=</span><span class="n">log_prior</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="n">inds</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[-234.53942834 -231.02130265 -232.90013003 -234.27506945 -234.66049471
  -238.07444275 -232.35687664 -231.33282587 -233.67086092 -238.11812911
  -233.20893301 -234.09371576 -234.35950776 -232.22459072 -232.06633741
  -235.14924797 -233.03502571 -234.18734006 -230.51431626 -232.61219376]
 [-231.84785934 -232.4996235  -234.89660657 -231.47214529 -232.43293087
  -233.62747615 -235.48686245 -235.88505379 -232.81529148 -234.000288
  -231.88576696 -232.18827551 -232.3379514  -231.98159959 -231.42321303
  -234.82683865 -239.88225406 -234.38151288 -233.2526001  -234.0482375 ]
 [-232.11299528 -233.91930072 -231.67132705 -233.62788986 -236.69915292
  -232.67648092 -234.48131299 -232.3694508  -238.60185876 -234.52455906
  -232.31049587 -234.91272623 -234.02915306 -237.34052966 -231.34264015
  -232.75469102 -232.51230222 -233.28482696 -232.04417766 -232.68530641]
 [-234.98873196 -232.27022538 -234.02160702 -232.6097875  -233.12256479
  -232.51232655 -232.38305872 -234.39744761 -232.54456678 -241.31865269
  -233.99560888 -231.83066202 -233.45669287 -232.97555293 -235.47289556
  -237.82879462 -237.12515607 -234.69000327 -232.51712538 -235.18290383]
 [-233.55378761 -231.7153107  -233.93375001 -237.1373893  -233.0021531
  -231.55257421 -235.63218495 -233.69963465 -234.95656002 -236.15331444
  -232.84681381 -235.14949305 -235.19049113 -234.73729493 -235.84691918
  -234.20051776 -233.97700027 -232.90405006 -231.80090043 -236.31972268]
 [-233.22935629 -244.47088888 -233.52984677 -233.1624634  -232.52160813
  -235.4239971  -231.90599161 -232.07991178 -233.26940541 -232.18534692
  -234.0045343  -238.2457443  -234.25944618 -232.65433651 -231.51234161
  -235.48667436 -239.54593479 -233.55193684 -232.15087362 -232.11305905]
 [-232.43249317 -233.64024438 -234.51116483 -231.9700249  -233.13734467
  -232.45596214 -235.28261781 -231.50436463 -235.75020097 -232.38331581
  -231.74661702 -231.73936328 -233.39069111 -234.666897   -234.3871745
  -232.55340893 -233.59297434 -234.35981222 -232.80624218 -232.2994188 ]
 [-237.15346466 -237.26099603 -231.99445268 -232.92400092 -241.55772242
  -233.78496045 -234.72814388 -233.26222602 -230.87478214 -236.95518865
  -232.97591135 -234.22613154 -232.51644465 -233.30659861 -231.16505166
  -233.74001296 -237.91957912 -235.65429024 -233.49679243 -231.5862158 ]] [[-5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916]
 [-5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916]
 [-5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916]
 [-5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916]
 [-5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916]
 [-5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916]
 [-5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916]
 [-5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916 -5.89946916
  -5.89946916 -5.89946916]]
</pre></div></div>
</div>
<p>Run the sampler</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">state</span><span class="o">.</span><span class="n">branches</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;gauss&#39;: &lt;eryn.state.Branch at 0x169d9d4c0&gt;,
 &#39;sine&#39;: &lt;eryn.state.Branch at 0x169d9d100&gt;}
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">nsteps</span> <span class="o">=</span> <span class="mi">5000</span>
<span class="n">last_sample</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">run_mcmc</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">nsteps</span><span class="p">,</span> <span class="n">burn</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">thin_by</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|███████████████████████████████████████| 1000/1000 [00:44&lt;00:00, 22.23it/s]
100%|███████████████████████████████████████| 5000/5000 [03:42&lt;00:00, 22.49it/s]
</pre></div></div>
</div>
<p>Let’s look at the last sample in terms of the <code class="docutils literal notranslate"><span class="pre">nleaves</span></code> array for both branches in the cold chain.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">last_sample</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="s2">&quot;gauss&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nleaves</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">last_sample</span><span class="o">.</span><span class="n">branches</span><span class="p">[</span><span class="s2">&quot;sine&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nleaves</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([[4, 2],
       [3, 3],
       [4, 2],
       [4, 2],
       [4, 2],
       [4, 2],
       [4, 2],
       [4, 2],
       [4, 2],
       [4, 2],
       [4, 2],
       [4, 2],
       [4, 2],
       [4, 2],
       [4, 2],
       [4, 2],
       [4, 2],
       [4, 2],
       [4, 2],
       [3, 3]])
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;max ll: </span><span class="si">{</span><span class="n">ensemble</span><span class="o">.</span><span class="n">get_log_like</span><span class="p">()</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">nleaves_gauss</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">get_nleaves</span><span class="p">()[</span><span class="s1">&#39;gauss&#39;</span><span class="p">]</span>
<span class="n">nleaves_sine</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">get_nleaves</span><span class="p">()[</span><span class="s1">&#39;sine&#39;</span><span class="p">]</span>
<span class="n">bns</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nleaves_max</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span>
<span class="p">)</span>  <span class="c1"># Just to make it pretty and center the bins</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ntemps</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
<span class="k">for</span> <span class="n">temp</span><span class="p">,</span> <span class="n">ax_t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ax</span><span class="p">):</span>
    <span class="n">ax_t</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">nleaves</span><span class="p">[:,</span> <span class="n">temp</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bns</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;royalblue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.8</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Gauss, T=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">temp</span><span class="p">))</span>
    <span class="n">ax_t</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">nleaves_sine</span><span class="p">[:,</span> <span class="n">temp</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bns</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.8</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Sine, T=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">temp</span><span class="p">),</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax_t</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>
<span class="n">ax_t</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Order $k$ of model&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
max ll: -224.91812775874538
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x1651583d0&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_93_2.png" src="../_images/tutorial_Eryn_tutorial_93_2.png" />
</div>
</div>
<p>To get the samples, we need remove any sources that were not used. We can combine <code class="docutils literal notranslate"><span class="pre">coords</span></code> and <code class="docutils literal notranslate"><span class="pre">inds</span></code> or we can remove anywhere where the backend returns <code class="docutils literal notranslate"><span class="pre">Nan</span></code>. Backends store <code class="docutils literal notranslate"><span class="pre">Nan</span></code> for the coordinates that belong to binaries that are not currently used (<code class="docutils literal notranslate"><span class="pre">inds</span> <span class="pre">==</span> <span class="pre">False</span></code>).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">samples</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">get_chain</span><span class="p">()[</span><span class="s1">&#39;gauss&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ndim</span><span class="p">)</span>

<span class="c1"># same as ensemble.get_chain()[&#39;gauss&#39;][ensemble.get_inds()[&#39;gauss&#39;]]</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">samples</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])]</span>

<span class="n">param_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;$A$&#39;</span><span class="p">,</span> <span class="s1">&#39;$\mu$&#39;</span><span class="p">,</span> <span class="s1">&#39;$\sigma$&#39;</span><span class="p">]</span>

<span class="n">c</span> <span class="o">=</span> <span class="n">ChainConsumer</span><span class="p">()</span>
<span class="n">c</span><span class="o">.</span><span class="n">add_chain</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">param_names</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#6495ed&#39;</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">shade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shade_alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">bar_shade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">usetex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gauss_inj_params</span><span class="p">)):</span>
    <span class="n">c</span><span class="o">.</span><span class="n">add_marker</span><span class="p">(</span><span class="n">gauss_inj_params</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">parameters</span><span class="o">=</span><span class="n">param_names</span><span class="p">,</span> <span class="n">marker_style</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">marker_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#DC143C&#39;</span><span class="p">)</span>

<span class="n">c</span><span class="o">.</span><span class="n">plotter</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">);</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;text.usetex&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">True</span> <span class="c1"># Update this becasue chaincnsumer is annoyinh</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_95_0.png" src="../_images/tutorial_Eryn_tutorial_95_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">samples</span> <span class="o">=</span> <span class="n">ensemble</span><span class="o">.</span><span class="n">get_chain</span><span class="p">()[</span><span class="s1">&#39;sine&#39;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ndims</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">samples</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])]</span>

<span class="n">param_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;$A_s$&#39;</span><span class="p">,</span> <span class="s1">&#39;$\omega$&#39;</span><span class="p">,</span> <span class="s1">&#39;$\phi$&#39;</span><span class="p">]</span>

<span class="n">c</span> <span class="o">=</span> <span class="n">ChainConsumer</span><span class="p">()</span>
<span class="n">c</span><span class="o">.</span><span class="n">add_chain</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">param_names</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">shade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shade_alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">bar_shade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">usetex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sine_inj_params</span><span class="p">)):</span>
    <span class="n">c</span><span class="o">.</span><span class="n">add_marker</span><span class="p">(</span><span class="n">sine_inj_params</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span> <span class="n">parameters</span><span class="o">=</span><span class="n">param_names</span><span class="p">,</span> <span class="n">marker_style</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">marker_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>

<span class="n">c</span><span class="o">.</span><span class="n">plotter</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">);</span>
<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;text.usetex&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">True</span> <span class="c1"># Update this becasue chaincnsumer is annoyinh</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="Searching-for-Gaussian-pulses-in-2D">
<h1>Searching for Gaussian pulses in 2D<a class="headerlink" href="#Searching-for-Gaussian-pulses-in-2D" title="Permalink to this headline">¶</a></h1>
<p>In this simple example we generate a noisy figure, which contains signals in the shape of 2D Gaussian pulses. We will attempt to estimate the nubmer of signals, as well as the level of the synthetic noise. First, we generate the data.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">num</span>     <span class="o">=</span> <span class="mi">100</span> <span class="c1"># the number of step for each dimension</span>
<span class="n">lowlim</span>  <span class="o">=</span> <span class="o">-</span><span class="mi">10</span> <span class="c1"># Low limit on each axis</span>
<span class="n">highlim</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># high limit on each axis</span>
<span class="n">npulses</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># The # of injected pulses</span>

<span class="n">dx</span> <span class="o">=</span> <span class="p">(</span><span class="n">highlim</span> <span class="o">-</span> <span class="n">lowlim</span><span class="p">)</span><span class="o">/</span><span class="n">num</span> <span class="c1"># Get the discritization</span>

<span class="n">x</span><span class="p">,</span> <span class="n">y</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="n">lowlim</span><span class="p">:</span><span class="n">highlim</span><span class="p">:</span><span class="n">dx</span><span class="p">,</span> <span class="n">lowlim</span><span class="p">:</span><span class="n">highlim</span><span class="p">:</span><span class="n">dx</span><span class="p">]</span> <span class="c1"># Generate the grid</span>
</pre></div>
</div>
</div>
<p>Now we define the parameters of the injection signals</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">Amp</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">npulses</span><span class="p">))</span> <span class="c1"># Draw an amplitude</span>
<span class="n">spread</span> <span class="o">=</span> <span class="mf">.2</span>  <span class="c1"># Keep their spread as fixed for simplicity.</span>
<span class="n">sigma</span>  <span class="o">=</span> <span class="n">spread</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>Do the actual injection</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">edges</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># Utility parameter, in order to avoid having signals at the border of our data set</span>

<span class="c1"># Draw the coordinates parameters</span>
<span class="n">inj_coordinates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">lowlim</span><span class="o">+</span><span class="n">edges</span><span class="p">,</span> <span class="n">highlim</span><span class="o">-</span><span class="n">edges</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">npulses</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

<span class="c1"># Gather all parameters here</span>
<span class="n">gauss_inj_params</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span><span class="n">AA</span><span class="p">,</span> <span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">AA</span><span class="p">,</span> <span class="n">xy</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">Amp</span><span class="p">,</span> <span class="n">inj_coordinates</span><span class="p">)]</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39; * Parameters injected: </span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">gauss_inj_params</span><span class="p">))</span>
</pre></div>
</div>
</div>
<p>We then can define the model and likelihood functions</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># First we compute some constant terms of the Gaussian models (reminder: we have assumed a fixed spread for each pulse)</span>
<span class="n">sigma_det</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
<span class="n">sigma_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
<span class="n">norm</span>      <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma_det</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">gaussian_flat</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span><span class="p">,))</span>
    <span class="n">pos</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
    <span class="n">pos</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span>
    <span class="c1"># This einsum call calculates (x-mu)T.Sigma-1.(x-mu) in a vectorized</span>
    <span class="c1"># way across all the input variables.</span>
    <span class="n">fac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;...k,kl,...l-&gt;...&#39;</span><span class="p">,</span> <span class="n">pos</span><span class="o">-</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma_inv</span><span class="p">,</span> <span class="n">pos</span><span class="o">-</span><span class="n">mu</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">a</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span> <span class="n">fac</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">norm</span>

<span class="k">def</span> <span class="nf">gaussian</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span>
    <span class="c1"># breakpoint()</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">x</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">y</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="n">c</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
    <span class="c1"># breakpoint()</span>
    <span class="n">C</span> <span class="o">=</span>  <span class="n">A</span><span class="o">*</span><span class="n">B</span><span class="p">[:,</span><span class="kc">None</span><span class="p">,:]</span> <span class="c1"># (np.expand_dims(A,axis=0) * np.expand_dims(np.transpose(B),axis=2))</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span> <span class="n">a</span> <span class="o">*</span> <span class="n">C</span> <span class="o">/</span> <span class="n">norm</span> <span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">log_prob_fn</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fill_inds</span><span class="o">=</span><span class="p">[],</span> <span class="n">fill_values</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">x</span>
    <span class="n">group1</span><span class="p">,</span> <span class="n">group2</span> <span class="o">=</span> <span class="n">groups</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">x1</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">x1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">x1</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">num</span> <span class="o">*</span> <span class="n">num</span>

    <span class="n">gauss_out</span>  <span class="o">=</span> <span class="n">gaussian</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
    <span class="n">num_groups</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">group1</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">template</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_groups</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">num</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_groups</span><span class="p">):</span>
        <span class="n">inds1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">group1</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span>
        <span class="n">given_signal</span> <span class="o">=</span> <span class="n">gauss_out</span><span class="p">[:,:,</span><span class="n">inds1</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">template</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">given_signal</span>

    <span class="n">sig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">x2</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">llh</span> <span class="o">=</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(((</span><span class="n">template</span> <span class="o">-</span> <span class="n">data</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="p">)</span>
    <span class="n">llh</span> <span class="o">*=</span> <span class="mi">1</span><span class="o">/</span><span class="n">sig</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">llh</span> <span class="o">+=</span> <span class="o">-</span> <span class="n">n</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span> <span class="o">-</span> <span class="mf">.5</span> <span class="o">*</span> <span class="n">n</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">llh</span>
</pre></div>
</div>
</div>
<p>We then generate the noise and add our injections.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">sigma_noise</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.2</span><span class="p">]]</span> <span class="c1"># The nosie variance</span>

<span class="n">noise</span> <span class="o">=</span> <span class="n">sigma_noise</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span> <span class="n">num</span><span class="p">,</span> <span class="n">num</span> <span class="p">)</span> <span class="c1"># Draw the random points for the noise</span>

<span class="c1"># Generate the data-set</span>
<span class="n">injection</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span> <span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span> <span class="p">)</span>
<span class="k">for</span> <span class="n">params</span> <span class="ow">in</span> <span class="n">gauss_inj_params</span><span class="p">:</span>
    <span class="n">injection</span> <span class="o">+=</span> <span class="n">gaussian_flat</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">injection</span> <span class="o">+</span> <span class="n">noise</span>

<span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">gauss_inj_params</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Plot everything below</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
<span class="n">cf</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">injection</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">PuBu</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">params</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">params</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#DC143C&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cf</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$x$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$y$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
<span class="n">cf</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">PuBu</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">params</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">params</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#DC143C&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$x$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$y$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cf</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>We then need to configure models and set-up our sample, in a very similar manner as we did for the simpler case before. Like in the previous case, we have two models that we need to sample for. One refers to the pulse signals, which we need to also estimate their total number in the data, and the other is the overal noise (no dynamical parameter space here).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ndims</span>        <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>           <span class="c1"># The dimensions of the two models we sample for here (# of parameter for each pulse, and # of parameters for the noise)</span>
<span class="n">nleaves_max</span>  <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">npulses</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>   <span class="c1"># Maximum number of components for each model type (noise is 1, because we don&#39;t want to use RJ MCMC on it).</span>
<span class="n">branch_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;pulse&quot;</span><span class="p">,</span> <span class="s2">&quot;noise&quot;</span><span class="p">]</span>

<span class="n">priors</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;pulse&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="mi">0</span><span class="p">:</span> <span class="n">uniform_dist</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">2.</span><span class="p">),</span>
        <span class="mi">1</span><span class="p">:</span> <span class="n">uniform_dist</span><span class="p">(</span><span class="n">lowlim</span><span class="p">,</span> <span class="n">highlim</span><span class="p">),</span>
        <span class="mi">2</span><span class="p">:</span> <span class="n">uniform_dist</span><span class="p">(</span><span class="n">lowlim</span><span class="p">,</span> <span class="n">highlim</span><span class="p">),</span>
    <span class="p">},</span>
    <span class="s2">&quot;noise&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="mi">0</span><span class="p">:</span> <span class="n">uniform_dist</span><span class="p">(</span><span class="mf">0.000001</span><span class="p">,</span> <span class="mf">2.</span><span class="p">),</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>Below we generate the coordinates for each walker, as done before. First we need to define the number of Temperatures and walkers we want to use.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ntemps</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">nwalkers</span> <span class="o">=</span> <span class="mi">30</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">coords</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">,</span> <span class="n">nleaf</span><span class="p">,</span> <span class="n">ndim</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">nleaf</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">nleaves_max</span><span class="p">,</span> <span class="n">ndims</span><span class="p">,</span> <span class="n">branch_names</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">sig1</span> <span class="o">=</span> <span class="mf">0.0000001</span>
<span class="k">for</span> <span class="n">nleaf</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">nleaves_max</span><span class="p">,</span> <span class="n">ndims</span><span class="p">,</span> <span class="n">branch_names</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nleaf</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;pulse&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nn</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gauss_inj_params</span><span class="p">):</span>
                <span class="n">kk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">npulses</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kk</span> <span class="o">=</span> <span class="n">nn</span>
            <span class="n">coords</span><span class="p">[</span><span class="n">name</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">gauss_inj_params</span><span class="p">[</span><span class="n">kk</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">sig1</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">coords</span><span class="p">[</span><span class="n">name</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">nn</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">sigma_noise</span><span class="p">[</span><span class="n">nn</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">sig1</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">))</span>


<span class="n">inds</span> <span class="o">=</span> <span class="p">{</span>
     <span class="n">name</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">,</span> <span class="n">nleaf</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
     <span class="k">for</span> <span class="n">nleaf</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">nleaves_max</span><span class="p">,</span> <span class="n">branch_names</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">inds</span><span class="p">[</span><span class="s1">&#39;pulse&#39;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">inds_temp</span> <span class="ow">in</span> <span class="n">inds</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">inds_fix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">inds_temp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ind1</span><span class="p">,</span> <span class="n">ind2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">inds_fix</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">inds_fix</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">inds_temp</span><span class="p">[</span><span class="n">ind1</span><span class="p">,</span> <span class="n">ind2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">groups</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">coords</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
        <span class="n">coords</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
    <span class="p">)[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">coords</span>
<span class="p">}</span>

<span class="n">groups</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">groups</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">groups</span>
<span class="p">}</span>

<span class="n">coords_in</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">coords</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">inds</span><span class="p">[</span><span class="n">name</span><span class="p">]]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">}</span>
<span class="n">groups_in</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">groups</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">inds</span><span class="p">[</span><span class="n">name</span><span class="p">]]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">}</span>

<span class="c1"># We compute the initial likelihood value at the injected coordinates:</span>
<span class="n">log_prob</span> <span class="o">=</span> <span class="n">log_prob_fn</span><span class="p">(</span>
    <span class="p">[</span><span class="n">coords_in</span><span class="p">[</span><span class="s2">&quot;pulse&quot;</span><span class="p">],</span> <span class="n">coords_in</span><span class="p">[</span><span class="s2">&quot;noise&quot;</span><span class="p">]],</span>
    <span class="p">[</span><span class="n">groups_in</span><span class="p">[</span><span class="s2">&quot;pulse&quot;</span><span class="p">],</span> <span class="n">groups_in</span><span class="p">[</span><span class="s2">&quot;noise&quot;</span><span class="p">]],</span>
    <span class="n">x</span><span class="p">,</span>
    <span class="n">y</span><span class="p">,</span>
    <span class="n">data</span><span class="p">,</span>
    <span class="n">fill_inds</span><span class="o">=</span><span class="p">[],</span>
    <span class="n">fill_values</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>What remains is to sample the dynamical parameter space! One last thing: Define proposal and initial temperature ladder:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">factor</span> <span class="o">=</span> <span class="mf">0.0001</span>
<span class="n">cov</span>    <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;pulse&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="o">*</span> <span class="n">factor</span><span class="p">,</span>
          <span class="s2">&quot;noise&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="n">factor</span><span class="p">}</span>
<span class="n">moves</span> <span class="o">=</span> <span class="n">GaussianMove</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>
<span class="n">betas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">ntemps</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Begin sampling. This might take a while, so you can reduce the <code class="docutils literal notranslate"><span class="pre">burnin</span></code> and <code class="docutils literal notranslate"><span class="pre">nsteps</span></code> to get a quick result.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>

<span></span><span class="n">ensemble</span> <span class="o">=</span> <span class="n">EnsembleSampler</span><span class="p">(</span>
    <span class="n">nwalkers</span><span class="p">,</span>
    <span class="n">ndims</span><span class="p">,</span>  <span class="c1"># assumes ndim_max</span>
    <span class="n">log_prob_fn</span><span class="p">,</span>
    <span class="n">priors</span><span class="p">,</span>
    <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">data</span><span class="p">],</span>
    <span class="n">tempering_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">betas</span><span class="o">=</span><span class="n">betas</span><span class="p">),</span>
    <span class="n">nbranches</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">branch_names</span><span class="p">),</span>
    <span class="n">branch_names</span><span class="o">=</span><span class="n">branch_names</span><span class="p">,</span>
    <span class="n">nleaves_max</span><span class="o">=</span><span class="n">nleaves_max</span><span class="p">,</span>
    <span class="n">provide_groups</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">update_iterations</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">plot_iterations</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">moves</span><span class="o">=</span><span class="n">moves</span><span class="p">,</span>
    <span class="n">rj_moves</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">nsteps</span> <span class="o">=</span> <span class="mi">500</span> <span class="c1"># Number of samples per walker</span>

<span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">log_like</span><span class="o">=</span><span class="n">log_prob</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">),</span> <span class="n">betas</span><span class="o">=</span><span class="n">betas</span><span class="p">,</span> <span class="n">blobs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="n">inds</span><span class="p">)</span>
<span class="n">ensemble</span><span class="o">.</span><span class="n">run_mcmc</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">nsteps</span><span class="p">,</span> <span class="n">burn</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">thin_by</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

</pre></div>
</div>
</div>
<p>We then plot the results below</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">get_clean_chain</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="n">temp</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Simple utility function to extract the squeezed chains for all the parameters</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">naninds</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">coords</span><span class="p">[:,</span> <span class="n">temp</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()))</span>
    <span class="n">samples_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">coords</span><span class="p">[:,</span> <span class="n">temp</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">naninds</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ndim</span><span class="p">))</span>  <span class="c1"># init the chains to plot</span>
    <span class="c1"># get the samples to plot</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">):</span>
        <span class="n">givenparam</span> <span class="o">=</span> <span class="n">coords</span><span class="p">[:,</span> <span class="n">temp</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">d</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">samples_in</span><span class="p">[:,</span> <span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">givenparam</span><span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">givenparam</span><span class="p">))</span>
        <span class="p">]</span>  <span class="c1"># Discard the NaNs, each time they change the shape of the samples_in</span>
    <span class="k">return</span> <span class="n">samples_in</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">pulse_parameters</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;$A$&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$x$&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;$y$&quot;</span><span class="p">]</span>
<span class="n">noise_parameters</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;$\sigma_\mathrm</span><span class="si">{noise}</span><span class="s2">$&quot;</span><span class="p">]</span>

<span class="n">samples_pulses</span> <span class="o">=</span> <span class="n">get_clean_chain</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">get_chain</span><span class="p">(</span><span class="n">thin</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="s1">&#39;pulse&#39;</span><span class="p">],</span> <span class="n">ndims</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">samples_noise</span> <span class="o">=</span> <span class="n">get_clean_chain</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">get_chain</span><span class="p">(</span><span class="n">thin</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="s1">&#39;noise&#39;</span><span class="p">],</span> <span class="n">ndims</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">c</span> <span class="o">=</span> <span class="n">ChainConsumer</span><span class="p">()</span>

<span class="n">c</span><span class="o">.</span><span class="n">add_chain</span><span class="p">(</span><span class="n">samples_pulses</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">pulse_parameters</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Pulses&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#6495ed&#39;</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">bar_shade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tick_font_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">label_font_size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">max_ticks</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">usetex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">serif</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npulses</span><span class="p">):</span>
    <span class="n">c</span><span class="o">.</span><span class="n">add_marker</span><span class="p">([</span><span class="n">gauss_inj_params</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">gauss_inj_params</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">gauss_inj_params</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">2</span><span class="p">]],</span> \
    <span class="n">parameters</span><span class="o">=</span><span class="n">pulse_parameters</span><span class="p">,</span> <span class="n">marker_style</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> \
    <span class="n">marker_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#DC143C&#39;</span><span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">plotter</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">c</span> <span class="o">=</span> <span class="n">ChainConsumer</span><span class="p">()</span>

<span class="n">c</span><span class="o">.</span><span class="n">add_chain</span><span class="p">(</span><span class="n">samples_noise</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">noise_parameters</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;noise&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">bar_shade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">tick_font_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">label_font_size</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">max_ticks</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">usetex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">serif</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">plotter</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">legend</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">truth</span><span class="o">=</span><span class="n">sigma_noise</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">get_clean_k_chains</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="n">temp</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Utility funtion to get the k-order chains</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">inds</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;inds&quot;</span><span class="p">)</span>  <span class="c1"># Get the leaves out</span>
    <span class="n">branches</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">inds</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">inds</span><span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">branch</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="n">branches</span><span class="p">):</span>  <span class="c1"># Get the total number of components/branches per temperature</span>
        <span class="k">if</span> <span class="n">branch</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="n">branches</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">k_chain</span> <span class="o">=</span> <span class="n">branches</span><span class="p">[</span><span class="n">branch</span><span class="p">][:,</span> <span class="n">temp</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">k_chain</span> <span class="o">+=</span> <span class="n">branches</span><span class="p">[</span><span class="n">branch</span><span class="p">][:,</span> <span class="n">temp</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">k_chain</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">gauss_k_chain_baseline</span> <span class="o">=</span> <span class="n">get_clean_k_chains</span><span class="p">(</span><span class="n">ensemble</span><span class="o">.</span><span class="n">backend</span><span class="p">)</span>

<span class="n">bns</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nleaves_max</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span>  <span class="c1"># Get maximum allowed number of leaves for the given branch</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
        <span class="n">gauss_k_chain_baseline</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">bins</span><span class="o">=</span><span class="n">bns</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#6495ed&#39;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
        <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">histtype</span><span class="o">=</span><span class="s1">&#39;step&#39;</span><span class="p">,</span>
        <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">hatch</span><span class="o">=</span><span class="s1">&#39;///&#39;</span>
        <span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">npulses</span><span class="p">),</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;#DC143C&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">([])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$\#$ of peaks in the data&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<section id="Moves">
<h2>Moves<a class="headerlink" href="#Moves" title="Permalink to this headline">¶</a></h2>
<p>Moves are generally implemented with the same three-tier structure that originated in <code class="docutils literal notranslate"><span class="pre">emcee</span></code>.</p>
<section id="Metropolis-Hastings">
<h3>Metropolis-Hastings<a class="headerlink" href="#Metropolis-Hastings" title="Permalink to this headline">¶</a></h3>
</section>
<section id="Red-Blue">
<h3>Red Blue<a class="headerlink" href="#Red-Blue" title="Permalink to this headline">¶</a></h3>
</section>
<section id="Reversible-Jump">
<h3>Reversible Jump<a class="headerlink" href="#Reversible-Jump" title="Permalink to this headline">¶</a></h3>
</section>
<section id="Group-Moves">
<h3>Group Moves<a class="headerlink" href="#Group-Moves" title="Permalink to this headline">¶</a></h3>
</section>
<section id="Gibbs-Sampling">
<h3>Gibbs Sampling<a class="headerlink" href="#Gibbs-Sampling" title="Permalink to this headline">¶</a></h3>
</section>
</section>
<section id="Utilities">
<h2>Utilities<a class="headerlink" href="#Utilities" title="Permalink to this headline">¶</a></h2>
<p>Eryn provides many different</p>
</section>
<section id="Transform-Container">
<h2>Transform Container<a class="headerlink" href="#Transform-Container" title="Permalink to this headline">¶</a></h2>
<p>Transform containers are primary used in likelihood functions to transform the arrays incoming from the sampler to the proper setup for likelihood computation. It can transform parameters based on transform functions and fill values into a final array for any value that is fixed during sampling.</p>
<p>It can be passed to the likeihood function as an <code class="docutils literal notranslate"><span class="pre">arg</span></code> or <code class="docutils literal notranslate"><span class="pre">kwarg</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># can be done with lambda or regular function</span>
<span class="c1"># must have same number of inputs and outputs at same index in outer arrays</span>
<span class="k">def</span> <span class="nf">transform1</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span> <span class="n">y</span> <span class="o">/</span> <span class="n">x</span>

<span class="c1"># this will do transform lambda x, y: (x**2, y**2) before transform1</span>
<span class="n">parameter_transforms</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="n">transform1</span><span class="p">}</span>

<span class="n">fill_dict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;ndim_full&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>  <span class="c1"># full dimensionality after values are added</span>
    <span class="s2">&quot;fill_inds&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]),</span>  <span class="c1"># indexes for fill values in final array</span>
    <span class="s2">&quot;fill_values&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">]),</span>  <span class="c1"># associated values for filling</span>
<span class="p">}</span>

<span class="n">tc</span> <span class="o">=</span> <span class="n">TransformContainer</span><span class="p">(</span><span class="n">parameter_transforms</span><span class="o">=</span><span class="n">parameter_transforms</span><span class="p">,</span> <span class="n">fill_dict</span><span class="o">=</span><span class="n">fill_dict</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

<span class="c1"># can copy and transpose values if needed</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">tc</span><span class="o">.</span><span class="n">transform_base_parameters</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_transpose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[[ 1.34430332e+00  8.18476660e+00  2.04085062e+00]
 [ 6.13084562e+00  3.05533801e+00  9.02491102e+00]
 [ 1.22919430e-01  4.09284339e+00  8.98848192e-02]
 [ 1.37682690e+01  4.43150106e+00  8.51564654e+00]
 [-2.35042400e+01  1.28537672e-01 -8.27705025e+00]
 [ 7.97484932e+00  6.73574678e+00  6.14823024e+00]
 [ 2.59320275e-01  9.64475288e-02  1.37513201e-01]
 [-8.17047397e-01  1.55045479e+00 -3.07445121e+00]
 [ 6.52416821e+00  6.02094524e-01  3.17120639e+01]
 [ 1.88145380e+00  2.19345426e+00  1.03413566e+00]
 [ 1.08549778e+00  2.73794101e+00  1.66880988e+00]
 [-3.11686841e+00  8.76259250e+00 -1.01315516e+01]
 [ 1.07468368e+01  3.33838821e-01  7.21161330e+00]
 [ 1.99354097e-01  7.88161252e+00  5.14486740e-01]
 [ 7.32068082e+00  8.52043784e-01  5.89509603e+00]
 [ 1.78499311e+01  1.01376123e+01  1.02075227e+01]
 [-1.42947592e-01  3.88745948e+00 -4.96527085e+01]
 [ 1.66122107e+01  1.12101611e+01  1.22284604e+01]
 [ 3.20548797e-01  3.81104680e-02  2.75093058e-01]
 [ 3.33334357e-02  5.60021016e+00  4.56603377e+00]
 [ 1.73453901e+01  9.45926001e+00  1.00763897e+01]
 [ 1.11695718e+01  4.30935739e+00  7.63289550e+00]
 [ 5.02270546e+00  2.46825112e-01  4.96558277e+00]
 [ 4.19677546e+00  6.54802683e-01  4.88919950e+00]
 [ 9.87675624e-01  5.86819753e+00  1.51769140e+00]
 [ 1.16537626e+01  8.64033414e+00  6.73973594e+00]
 [ 1.49072689e+00  7.89857095e+00  2.78350627e+00]
 [ 1.81971310e+01  3.04813802e+00  1.16435240e+01]
 [-6.07094253e+00  1.24677518e+00 -2.03129112e+01]
 [ 1.36005419e+01  1.65902617e+00  1.80771880e+01]
 [ 7.42055126e-01  8.82191523e-01  4.90560996e+00]
 [ 6.77193265e-01  2.48706861e+00  6.70370343e-01]
 [-1.43095419e+01  2.10607613e+00 -4.74428957e+00]
 [ 1.61778825e+00  7.24489929e+00  8.48739238e-01]
 [ 1.37673018e+01  4.92018414e+00  1.30258484e+01]
 [ 3.55919706e-01  7.87675654e+00  3.51402255e-01]
 [-1.62008336e+01  2.44337171e+00 -7.28431001e+00]
 [-1.31839853e+00  1.16547373e+01 -4.35281241e+01]
 [ 9.82630065e-01  2.97659423e+00  4.70305612e+00]
 [ 1.18462154e+01  5.02420619e+00  1.39073627e+01]]
</pre></div></div>
</div>
<p>If you have mutliple branches in your sampler, you can add more than one <code class="docutils literal notranslate"><span class="pre">Transform</span> <span class="pre">Container</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">lnprob</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">group1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">group2</span><span class="p">,</span> <span class="n">transform_containers</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">x_i</span><span class="p">,</span> <span class="n">transform</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">],</span> <span class="n">transform_containers</span><span class="p">)):</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">transform_base_parameters</span><span class="p">(</span><span class="n">x_i</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">return_transpose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">fill_values</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="c1">## do more in the likelihood here with transformed information</span>

<span class="c1"># setup transforms for x1</span>
<span class="n">parameter_transforms1</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="p">)}</span>

<span class="c1"># setup transforms for x2</span>
<span class="n">parameter_transforms2</span> <span class="o">=</span> <span class="p">{(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">)}</span>

<span class="c1"># fill dict for x1</span>
<span class="n">fill_dict1</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;ndim_full&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>  <span class="c1"># full dimensionality after values are added</span>
    <span class="s2">&quot;fill_inds&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">]),</span>  <span class="c1"># indexes for fill values in final array</span>
    <span class="s2">&quot;fill_values&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">]),</span>  <span class="c1"># associated values for filling</span>
<span class="p">}</span>

<span class="c1"># fill dict for x2</span>
<span class="n">fill_dict2</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;ndim_full&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>  <span class="c1"># full dimensionality after values are added</span>
    <span class="s2">&quot;fill_inds&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">]),</span>  <span class="c1"># indexes for fill values in final array</span>
    <span class="s2">&quot;fill_values&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.0</span><span class="p">]),</span>  <span class="c1"># associated values for filling</span>
<span class="p">}</span>

<span class="n">tcs</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">TransformContainer</span><span class="p">(</span><span class="n">parameter_transforms</span><span class="o">=</span><span class="n">parameter_transforms1</span><span class="p">,</span> <span class="n">fill_dict</span><span class="o">=</span><span class="n">fill_dict1</span><span class="p">),</span>
    <span class="n">TransformContainer</span><span class="p">(</span><span class="n">parameter_transforms</span><span class="o">=</span><span class="n">parameter_transforms2</span><span class="p">,</span> <span class="n">fill_dict</span><span class="o">=</span><span class="n">fill_dict2</span><span class="p">),</span>
<span class="p">]</span>

<span class="n">num</span> <span class="o">=</span> <span class="mi">40</span>
<span class="n">x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">x2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">num</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="n">group1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>
<span class="n">group2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num</span><span class="p">)</span>

<span class="c1"># it can be added via args or kwargs in the ensemble sampler</span>
<span class="n">lnprob</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">group1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">group2</span><span class="p">,</span> <span class="n">tcs</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[array([[-0.56819236,  2.05566347,  0.        ,  1.        ,  1.70157891,
        -1.        ],
       [ 0.98420683,  0.80471591,  0.        ,  1.        ,  0.86993299,
        -1.        ],
       [-1.7915778 ,  2.27296471,  0.        ,  1.        ,  0.4577592 ,
        -1.        ],
       [-1.91887059,  1.95427347,  0.        ,  1.        ,  2.04501765,
        -1.        ],
       [ 1.33792689,  0.17095355,  0.        ,  1.        ,  3.25206687,
        -1.        ],
       [ 1.34800321,  2.84822691,  0.        ,  1.        ,  3.77657866,
        -1.        ],
       [ 0.229263  ,  3.83419582,  0.        ,  1.        ,  3.17212956,
        -1.        ],
       [ 0.79691907,  0.31199857,  0.        ,  1.        ,  2.50395197,
        -1.        ],
       [ 0.51709738,  2.40245944,  0.        ,  1.        ,  3.23815906,
        -1.        ],
       [-0.75006537,  0.32946041,  0.        ,  1.        ,  3.08583184,
        -1.        ],
       [ 0.01247352,  1.50185175,  0.        ,  1.        ,  0.51482301,
        -1.        ],
       [ 0.76660567,  1.68375903,  0.        ,  1.        ,  3.13781464,
        -1.        ],
       [ 0.39764376,  2.33008793,  0.        ,  1.        ,  1.78158083,
        -1.        ],
       [ 1.22984752,  3.51806999,  0.        ,  1.        ,  1.04196319,
        -1.        ],
       [-1.25706864,  0.3174162 ,  0.        ,  1.        ,  0.44550036,
        -1.        ],
       [-0.13589034,  3.1083969 ,  0.        ,  1.        ,  3.93745994,
        -1.        ],
       [ 0.91277291,  3.32717808,  0.        ,  1.        ,  3.98060979,
        -1.        ],
       [ 1.14127145,  0.59434966,  0.        ,  1.        ,  0.87924708,
        -1.        ],
       [-0.56503321,  2.28033163,  0.        ,  1.        ,  1.17051664,
        -1.        ],
       [-0.14172443,  2.86611623,  0.        ,  1.        ,  2.44751591,
        -1.        ],
       [ 1.25462944,  3.29858091,  0.        ,  1.        ,  0.97480747,
        -1.        ],
       [ 1.38428251,  3.11638521,  0.        ,  1.        ,  1.13233396,
        -1.        ],
       [ 1.27576213,  2.14711677,  0.        ,  1.        ,  1.58826282,
        -1.        ],
       [-1.99799715,  0.15495658,  0.        ,  1.        ,  3.80472759,
        -1.        ],
       [ 0.87075043,  1.82323474,  0.        ,  1.        ,  2.37441299,
        -1.        ],
       [ 0.2788264 ,  1.92227559,  0.        ,  1.        ,  3.33280623,
        -1.        ],
       [ 1.19206818,  3.99927396,  0.        ,  1.        ,  1.69796936,
        -1.        ],
       [ 1.22844477,  0.97458292,  0.        ,  1.        ,  0.50145692,
        -1.        ],
       [-1.35021131,  2.22836449,  0.        ,  1.        ,  2.42150205,
        -1.        ],
       [-0.18110708,  3.11229539,  0.        ,  1.        ,  0.20218149,
        -1.        ],
       [ 1.36444012,  2.48208369,  0.        ,  1.        ,  0.48339395,
        -1.        ],
       [ 0.65224242,  2.02534703,  0.        ,  1.        ,  2.73286134,
        -1.        ],
       [-0.81996524,  0.22944459,  0.        ,  1.        ,  3.13478256,
        -1.        ],
       [-0.31948994,  0.27044772,  0.        ,  1.        ,  1.38943175,
        -1.        ],
       [ 0.36940683,  0.43392956,  0.        ,  1.        ,  3.49831459,
        -1.        ],
       [ 0.56111773,  2.05689291,  0.        ,  1.        ,  1.61988424,
        -1.        ],
       [ 1.12829041,  1.77632577,  0.        ,  1.        ,  2.90875721,
        -1.        ],
       [ 1.16832224,  0.45945728,  0.        ,  1.        ,  1.45541997,
        -1.        ],
       [-1.88704296,  0.78868953,  0.        ,  1.        ,  3.75359813,
        -1.        ],
       [ 0.76975401,  2.50765122,  0.        ,  1.        ,  1.09850888,
        -1.        ]]), array([[ 1.32063522, -1.        ,  7.25606378, 10.31947777,  1.38912574],
       [ 3.16999551, -1.        ,  1.83122764, 14.65396145,  3.11590695],
       [ 2.1643392 , -1.        , 14.46310765,  0.02533148,  3.93814692],
       [ 3.2049484 , -1.        ,  0.50397605,  4.98696755,  2.54284133],
       [ 0.17076619, -1.        ,  7.47741221,  0.5406243 ,  2.92974161],
       [ 1.73051978, -1.        ,  7.80759402,  4.12751742,  0.37812945],
       [ 0.21151749, -1.        , 14.18403045,  1.86810862,  0.48877934],
       [ 2.43194562, -1.        ,  0.06373639,  2.14306616,  3.36288846],
       [ 0.86211383, -1.        ,  5.06957013, 10.83212535,  3.84694585],
       [ 1.4189157 , -1.        , 12.88431853,  6.69307164,  3.55562818],
       [ 1.18885226, -1.        , 10.51093162,  7.56621935,  0.77753331],
       [ 1.17668351, -1.        ,  1.9943762 ,  7.26784771,  0.26981164],
       [ 2.05102605, -1.        ,  5.86023259,  0.95607095,  0.39186698],
       [ 2.41079144, -1.        ,  2.73252672, 12.39633936,  2.13304026],
       [ 3.14534841, -1.        , 15.05866917,  0.06263261,  2.19062955],
       [ 0.53756608, -1.        ,  8.11545799, 12.26079383,  1.47431836],
       [ 0.95870397, -1.        ,  9.89449737,  0.27653066,  3.93134606],
       [ 2.01338383, -1.        ,  0.14280689,  0.10675667,  0.8063841 ],
       [ 0.355005  , -1.        , 11.58165697, 10.00102761,  0.55767889],
       [ 0.85853508, -1.        ,  4.05818408,  0.91438102,  2.02237919],
       [ 3.76454168, -1.        ,  1.84806292,  6.10698231,  3.87920106],
       [ 3.53196235, -1.        ,  5.84176248,  1.19579088,  3.63250901],
       [ 3.77699276, -1.        ,  4.14453345, 15.50757065,  3.51605494],
       [ 3.49225627, -1.        ,  8.40493479,  4.47284096,  2.7630765 ],
       [ 3.78859192, -1.        ,  8.00295604,  5.37835271,  2.96876662],
       [ 1.53585312, -1.        ,  6.21201513,  0.28430854,  1.25647479],
       [ 3.78746461, -1.        ,  0.44409094,  1.55023343,  2.33613412],
       [ 2.16202368, -1.        ,  3.47415587, 15.56807802,  0.37440893],
       [ 0.23080702, -1.        ,  5.73884938,  0.57704524,  1.87331263],
       [ 3.54737922, -1.        ,  0.48460663, 11.58529642,  3.58995863],
       [ 3.78768034, -1.        ,  8.01746378,  5.63417002,  3.33983639],
       [ 0.7863916 , -1.        ,  1.15428477, 13.39570542,  2.29278937],
       [ 0.56566261, -1.        , 14.6832176 ,  0.10581503,  3.01022661],
       [ 1.54802815, -1.        ,  1.72821738, 12.94638128,  3.18927379],
       [ 2.54896029, -1.        ,  2.41450257,  2.03807117,  3.41874819],
       [ 1.75913511, -1.        ,  9.18931264,  0.68291839,  2.63769379],
       [ 3.30134059, -1.        ,  6.37320886,  1.97889819,  2.12441082],
       [ 2.77308867, -1.        ,  0.50066952, 11.43194067,  1.34732807],
       [ 1.30785374, -1.        ,  3.55095814, 13.17827168,  2.94398989],
       [ 1.18593269, -1.        , 11.22346112, 12.26836663,  2.41622093]])]
</pre></div></div>
</div>
</section>
</section>
<section id="Choosing-the-optimal-B-Spline-order">
<h1>Choosing the optimal B-Spline order<a class="headerlink" href="#Choosing-the-optimal-B-Spline-order" title="Permalink to this headline">¶</a></h1>
<p>In this section we will attempt to fit a spectrum using a shape-agnostic model based on B-spline interpolation. The motivation of the problem is to determine the optimal number of free knots that are best describing the data, avoiding over-fitting situations. A very useful package is <a class="reference external" href="https://github.com/karnesis/spectral">this</a> one, which is a simple package for performing spectral analysis. Has a lot of window functions, but more importantly, it contains the log-PSD function, which we will
use in order to reduce the computational complexity of the problem. For more invormation about the <code class="docutils literal notranslate"><span class="pre">lpsd</span></code> method you can check <a class="reference external" href="https://pure.mpg.de/rest/items/item_150688/component/file_150687/content">this</a> paper.</p>
<p>First we set-up the type of measurement. The duration, cadence, also try to define the total number of steps for our sampler.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">Tobs</span>  <span class="o">=</span> <span class="mf">1e6</span>                     <span class="c1"># Duration of data</span>
<span class="n">dt</span>    <span class="o">=</span> <span class="mi">10</span>                      <span class="c1"># Delta-t [s]</span>
<span class="n">fs</span>    <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">dt</span>                    <span class="c1"># Sampling frequency</span>
<span class="n">Ndata</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Tobs</span><span class="o">/</span><span class="n">dt</span><span class="p">)</span>            <span class="c1"># Number of data points</span>
<span class="n">tvec</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Tobs</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>  <span class="c1"># Get the time vector</span>
<span class="n">df</span>    <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">Tobs</span>                <span class="c1"># Define Delta-f</span>
<span class="n">burnin</span><span class="o">=</span><span class="mi">1000</span>
<span class="n">nsteps</span><span class="o">=</span><span class="mi">2000</span>
</pre></div>
</div>
</div>
<p>We then need to simulate some time-series. We could totally do this directly in frequency domain, but we will generate synthetic time series in order to use the <code class="docutils literal notranslate"><span class="pre">lpsd</span></code> function, which is useful for now. We start by defining our “true”, or “theoretical” PSD of the data, which we will use to generate our data-set.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>

<span></span><span class="k">if</span> <span class="p">(</span><span class="n">Ndata</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>              <span class="c1"># Get the number of requencies</span>
    <span class="n">nfft</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">Ndata</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">nfft</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">Ndata</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

<span class="n">F</span>     <span class="o">=</span> <span class="n">df</span><span class="o">*</span><span class="n">nfft</span>                 <span class="c1"># make the positive frequency vector</span>
<span class="n">fvec</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>

<span class="c1"># Define a smooth model for the PSD of the noise</span>
<span class="n">fstar</span><span class="o">=</span><span class="mf">8e-3</span>
<span class="n">n1</span><span class="o">=-</span><span class="mi">5</span>
<span class="n">n2</span><span class="o">=</span><span class="mi">5</span>
<span class="n">amp</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">noisemodel</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">f</span> <span class="p">:</span> <span class="mf">1e-3</span><span class="o">/</span><span class="n">f</span> <span class="o">+</span> <span class="mi">50</span><span class="o">*</span><span class="n">f</span> <span class="o">+</span> <span class="n">amp</span> <span class="o">*</span> <span class="p">(</span><span class="n">f</span><span class="o">**</span><span class="p">(</span><span class="n">n1</span> <span class="o">+</span> <span class="n">n2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">fstar</span><span class="o">**</span><span class="n">n1</span> <span class="o">*</span> <span class="n">f</span><span class="o">**</span><span class="n">n2</span> <span class="o">+</span> <span class="n">fstar</span><span class="o">**</span><span class="n">n2</span> <span class="o">*</span> <span class="n">f</span><span class="o">**</span><span class="n">n1</span><span class="p">)</span> <span class="p">)</span>

<span class="c1"># Get the PSD of the noise using hte model above</span>
<span class="n">Sn</span> <span class="o">=</span> <span class="n">noisemodel</span><span class="p">(</span><span class="n">fvec</span><span class="p">)</span>

<span class="c1"># Remove first nan (assume also zero-mean)</span>
<span class="n">Sn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/var/folders/yz/xf637mpx56g2dvdv9d8v1fnm0000gn/T/ipykernel_13472/1282363938.py:14: RuntimeWarning: divide by zero encountered in true_divide
  noisemodel = lambda f : 1e-3/f + 50*f + amp * (f**(n1 + n2) / (fstar**n1 * f**n2 + fstar**n2 * f**n1) )
/var/folders/yz/xf637mpx56g2dvdv9d8v1fnm0000gn/T/ipykernel_13472/1282363938.py:14: RuntimeWarning: divide by zero encountered in power
  noisemodel = lambda f : 1e-3/f + 50*f + amp * (f**(n1 + n2) / (fstar**n1 * f**n2 + fstar**n2 * f**n1) )
</pre></div></div>
</div>
<p>Import the spectral module for convenience. It contains tons of windows and some spectral utility functions.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">spectral</span> <span class="kn">import</span> <span class="n">genTimeSeriesFromPSD</span><span class="p">,</span> <span class="n">lpsd</span><span class="p">,</span> <span class="n">welchpsd</span>
</pre></div>
</div>
</div>
<p>We generate the time-series by <code class="docutils literal notranslate"><span class="pre">ifft</span></code>-ing from the PSD model we provided. We then compute the PSD of the data using hte Welch method.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">navs</span> <span class="o">=</span> <span class="mi">30</span>

<span class="c1">## Generate time-series here</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> # Generating noisy data with </span><span class="se">\n\t</span><span class="s1"> Tobs: </span><span class="si">{}</span><span class="s1"> </span><span class="se">\n\t</span><span class="s1">Ndata: </span><span class="si">{}</span><span class="s1"> </span><span class="se">\n\t</span><span class="s1">  dt: </span><span class="si">{}</span><span class="s1"> </span><span class="se">\n\t</span><span class="s1">  df: </span><span class="si">{}</span><span class="se">\n\t</span><span class="s1"> &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Tobs</span><span class="p">,</span> <span class="n">Ndata</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">df</span><span class="p">))</span>
<span class="n">my_data</span> <span class="o">=</span> <span class="n">genTimeSeriesFromPSD</span><span class="p">(</span><span class="n">Sn</span><span class="p">,</span><span class="n">fs</span><span class="p">)</span> <span class="c1"># I divide by two because the function assumes the 2-sided spectrum</span>

<span class="n">f20</span><span class="p">,</span> <span class="n">S20</span> <span class="o">=</span> <span class="n">welchpsd</span><span class="p">(</span><span class="n">my_data</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">Ndata</span><span class="o">/</span><span class="n">navs</span><span class="p">),</span> <span class="n">win</span><span class="o">=</span><span class="s1">&#39;nuttall4c&#39;</span><span class="p">)</span>
<span class="n">fr1</span><span class="p">,</span> <span class="n">S1</span> <span class="o">=</span> <span class="n">welchpsd</span><span class="p">(</span><span class="n">my_data</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">Ndata</span><span class="p">,</span> <span class="n">win</span><span class="o">=</span><span class="s1">&#39;nuttall4c&#39;</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

 # Generating noisy data with
         Tobs: 1000000.0
        Ndata: 100000
          dt: 10
          df: 1e-06

</pre></div></div>
</div>
<p>In order to save some computatational time, we use the <code class="docutils literal notranslate"><span class="pre">lpsd</span></code> method, which is basically a method to compute the PSD of time-series, using the optimal number of averages at each frequeny. The frequency grid is equally spaced in log, and pre-defined. For more information, you can tcheck <a class="reference external" href="https://www.sciencedirect.com/science/article/abs/pii/S026322410500117X?via%3Dihub">this</a> paper.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">f0</span> <span class="o">=</span> <span class="mf">1e-4</span>
<span class="n">f1</span> <span class="o">=</span> <span class="mf">5e-2</span>

<span class="n">fl</span><span class="p">,</span> <span class="n">Sl</span><span class="p">,</span> <span class="n">Sle</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">Kavs</span> <span class="o">=</span> <span class="n">lpsd</span><span class="p">(</span><span class="n">my_data</span><span class="p">,</span> <span class="n">fs</span><span class="p">,</span> <span class="n">Kdes</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">Jdes</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">flims</span><span class="o">=</span><span class="p">[</span><span class="n">f0</span><span class="p">,</span> <span class="n">f1</span><span class="p">],</span> <span class="n">win</span><span class="o">=</span><span class="s1">&#39;nuttall4b&#39;</span><span class="p">,</span> <span class="n">winalpha</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">olap</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">errrype</span><span class="o">=</span><span class="s1">&#39;std&#39;</span><span class="p">,</span> <span class="n">DOPLOT</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">VERBOSE</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">errs</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">Sle</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">Sle</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">fr1</span><span class="p">,</span> <span class="n">S1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Numerically calculated PSD, with N=1&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">f20</span><span class="p">,</span> <span class="n">S20</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Numerically calculated PSD, with N=</span><span class="si">{</span><span class="n">navs</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;cornflowerblue&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">fl</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">Sl</span><span class="p">),</span> <span class="n">yerr</span><span class="o">=</span><span class="n">errs</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;logPSD&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;crimson&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">fvec</span><span class="p">,</span> <span class="n">Sn</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;My PSD theoretical model&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">fvec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fvec</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;[1/Hz]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency [Hz]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower left&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x7fedde6bdca0&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_150_1.png" src="../_images/tutorial_Eryn_tutorial_150_1.png" />
</div>
</div>
<p>Now we setting up the sampler.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">maxmodels</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">ntemps</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">nwalkers</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">backendname</span> <span class="o">=</span> <span class="s1">&#39;a_test&#39;</span>
</pre></div>
</div>
</div>
<p>For this investigation, we need two models. One model concerns the knots at the edges of the spectrum, which we only do parameter estimation for their respective amplitude. So, no reversible jump for this one. We do this by simply setting the maximum number of leaves to <code class="docutils literal notranslate"><span class="pre">1</span></code>. The second model is the one that is dynamic, each component having an amplitude and a position parameter. We call those models <code class="docutils literal notranslate"><span class="pre">edges</span></code> and <code class="docutils literal notranslate"><span class="pre">knots</span></code> respectively.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ndims</span>        <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="c1"># The first is control point + knot, the second two control points (knots are the edges)</span>
<span class="n">nleaves_max</span>  <span class="o">=</span> <span class="p">[</span><span class="n">maxmodels</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">nleaves_min</span>  <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">branch_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;knots&quot;</span><span class="p">,</span> <span class="s2">&quot;edges&quot;</span><span class="p">]</span>

<span class="c1"># Restrict the frequency band</span>
<span class="n">i_band</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">fl</span><span class="o">&gt;=</span><span class="n">f0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">fl</span><span class="o">&lt;=</span><span class="n">f1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">mx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">noisemodel</span><span class="p">(</span><span class="n">fl</span><span class="p">[</span><span class="n">i_band</span><span class="p">])))</span>
<span class="n">mn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">noisemodel</span><span class="p">(</span><span class="n">fl</span><span class="p">[</span><span class="n">i_band</span><span class="p">])))</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;max:&#39;</span><span class="p">,</span> <span class="n">mx</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;min:&#39;</span><span class="p">,</span> <span class="n">mn</span><span class="p">)</span>

<span class="c1">#The prior on the knot amplitude could be dependent on the frequency, but I choose</span>
<span class="c1">#to be simple here</span>
<span class="n">priors</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;knots&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="mi">0</span><span class="p">:</span> <span class="n">uniform_dist</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">f0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">f1</span><span class="p">)),</span>
        <span class="mi">1</span><span class="p">:</span> <span class="n">uniform_dist</span><span class="p">(</span><span class="mf">1.5</span><span class="o">*</span><span class="n">mn</span><span class="p">,</span> <span class="mf">1.2</span><span class="o">*</span><span class="n">mx</span><span class="p">),</span>
    <span class="p">},</span>
    <span class="s2">&quot;edges&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="mi">0</span><span class="p">:</span> <span class="n">uniform_dist</span><span class="p">(</span><span class="mf">1.5</span><span class="o">*</span><span class="n">mn</span><span class="p">,</span> <span class="mf">1.2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">noisemodel</span><span class="p">(</span><span class="n">fl</span><span class="p">[</span><span class="mi">0</span><span class="p">]))),</span>
        <span class="mi">1</span><span class="p">:</span> <span class="n">uniform_dist</span><span class="p">(</span><span class="mf">1.5</span><span class="o">*</span><span class="n">mn</span><span class="p">,</span> <span class="mf">1.3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">noisemodel</span><span class="p">(</span><span class="n">fl</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))),</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
max: 2.2400506683151953
min: -0.7418475507541406
</pre></div></div>
</div>
<p>Setting up the input coordinates. This might be easier in the future, but hte functionality should remain.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>

<span></span><span class="c1"># Initialize the knots fr,</span>
<span class="n">coords</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">,</span> <span class="n">nleaf</span><span class="p">,</span> <span class="n">ndim</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">nleaf</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">nleaves_max</span><span class="p">,</span> <span class="n">ndims</span><span class="p">,</span> <span class="n">branch_names</span><span class="p">)</span>
<span class="p">}</span>


<span class="n">sig1</span> <span class="o">=</span> <span class="mf">0.0001</span>
<span class="k">for</span> <span class="n">nleaf</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">nleaves_max</span><span class="p">,</span> <span class="n">ndims</span><span class="p">,</span> <span class="n">branch_names</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;# </span><span class="si">{}</span><span class="s1">: Max models = </span><span class="si">{}</span><span class="s1">, dim = </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">nleaf</span><span class="p">,</span> <span class="n">ndim</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">nn</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nleaf</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;knots&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">):</span>
                <span class="n">coords</span><span class="p">[</span><span class="n">name</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">nn</span><span class="p">,</span> <span class="n">dd</span><span class="p">]</span> <span class="o">=</span> <span class="n">priors</span><span class="p">[</span><span class="s1">&#39;knots&#39;</span><span class="p">][</span><span class="n">dd</span><span class="p">]</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">ntemps</span><span class="p">,</span><span class="n">nwalkers</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dd</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndim</span><span class="p">):</span>
                <span class="n">coords</span><span class="p">[</span><span class="n">name</span><span class="p">][:,</span> <span class="p">:,</span> <span class="n">nn</span><span class="p">,</span> <span class="n">dd</span><span class="p">]</span> <span class="o">=</span> <span class="n">priors</span><span class="p">[</span><span class="s1">&#39;edges&#39;</span><span class="p">][</span><span class="n">dd</span><span class="p">]</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">ntemps</span><span class="p">,</span><span class="n">nwalkers</span><span class="p">))</span> <span class="c1"># np.random.multivariate_normal(edges_starting_params[nn], np.diag(np.ones(2) * sig1), size=(ntemps, nwalkers))</span>

<span class="n">indxs</span> <span class="o">=</span> <span class="p">{</span>
     <span class="n">name</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">,</span> <span class="n">nleaf</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
     <span class="k">for</span> <span class="n">nleaf</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">nleaves_max</span><span class="p">,</span> <span class="n">branch_names</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">indxs</span><span class="p">[</span><span class="s1">&#39;knots&#39;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

<span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">inds_temp</span> <span class="ow">in</span> <span class="n">indxs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">inds_fix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">inds_temp</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">ind1</span><span class="p">,</span> <span class="n">ind2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">inds_fix</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">inds_fix</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
        <span class="n">inds_temp</span><span class="p">[</span><span class="n">ind1</span><span class="p">,</span> <span class="n">ind2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">groups</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">coords</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
        <span class="n">coords</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
    <span class="p">)[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">coords</span>
<span class="p">}</span>

<span class="n">groups</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">groups</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">coords</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">groups</span>
<span class="p">}</span>

<span class="n">coords_in</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">coords</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">indxs</span><span class="p">[</span><span class="n">name</span><span class="p">]]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">coords</span><span class="p">}</span>
<span class="n">groups_in</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">groups</span><span class="p">[</span><span class="n">name</span><span class="p">][</span><span class="n">indxs</span><span class="p">[</span><span class="n">name</span><span class="p">]]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">}</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
# knots: Max models = 20, dim = 2
# edges: Max models = 1, dim = 2
</pre></div></div>
</div>
<p>Now we need to define the likelihood function. It hadles</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">class</span> <span class="nc">SplineLikelihoodDynamic</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">log_per</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">inf</span><span class="o">=</span><span class="mf">1e14</span><span class="p">,</span> <span class="n">expmax</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span><span class="p">,</span> <span class="n">ftol</span><span class="o">=</span><span class="mf">.1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gaussian likelihood model using a smoothed log-periodogram,</span>
<span class="sd">        assuming the data contains only noise.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fr : ndarray</span>
<span class="sd">            frequency array of the estimation domain, size nf</span>
<span class="sd">        log_per : ndarray</span>
<span class="sd">            log-periodogram array, size nf</span>
<span class="sd">        N : ndarray</span>
<span class="sd">            array of averages per frequency, size nf</span>
<span class="sd">        var : float</span>
<span class="sd">            variance of the log-periodogram bins</span>
<span class="sd">        instr : NoisePSD instance</span>
<span class="sd">            class to compute the instrumental log-PSD</span>
<span class="sd">        inf : float or np.inf</span>
<span class="sd">            if the likelihood diverge, it will be set equal to - inf</span>
<span class="sd">        expmax : float</span>
<span class="sd">            maximum value allowed in the exponential function. If this is reached,</span>
<span class="sd">            the log-likelihood will return -infinity.</span>
<span class="sd">        kind : string</span>
<span class="sd">            Interpolation kind. Set to &#39;cubic&#39; by default.</span>
<span class="sd">        ftol : float [ 0 &lt; ftol]</span>
<span class="sd">            Tolerance on proximity of knots in logspace</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Frequency of data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freq</span>   <span class="o">=</span> <span class="n">freq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Nsegs</span> <span class="o">=</span> <span class="n">N</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_N</span>     <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logfr</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
        <span class="c1"># Discrete Fourier transform of data (already normalized)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_per</span> <span class="o">=</span> <span class="n">log_per</span>
        <span class="c1"># Maximum value allowed in the exponential function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expmax</span> <span class="o">=</span> <span class="n">expmax</span>
        <span class="c1"># Interpolation kind</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="n">kind</span>
        <span class="c1"># tolerance on proximity of knots in logspace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ftol</span> <span class="o">=</span> <span class="n">ftol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inf</span> <span class="o">=</span> <span class="n">inf</span>

    <span class="k">def</span> <span class="nf">get_noise_psd_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">groups</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the spline model for the noise PSD, given some knots</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x, groups : ndarray</span>
<span class="sd">            PSD parameters</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        instr : interpolate.interp1d evaluated</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># I will consider two models. One handling the internal knots, and one for the edges</span>
        <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">group1</span><span class="p">,</span> <span class="n">group2</span> <span class="o">=</span> <span class="n">groups</span>
        <span class="n">knots</span> <span class="o">=</span> <span class="n">x1</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">control_points</span> <span class="o">=</span> <span class="n">x1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Get the edges info</span>
        <span class="n">control_points_edges</span> <span class="o">=</span> <span class="n">x2</span>

        <span class="n">num_groups</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">group1</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># log_psd_model = np.zeros((num_groups, len(self.freq)))</span>
        <span class="n">log_psd_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">num_groups</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">freq</span><span class="p">)))</span>
        <span class="n">log_psd_model</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">failed</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Loop over the temperatures vs walkers</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_groups</span><span class="p">):</span>
            <span class="n">inds1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">group1</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">knots_i</span> <span class="o">=</span> <span class="n">knots</span><span class="p">[</span><span class="n">inds1</span><span class="p">]</span>
            <span class="n">control_points_i</span> <span class="o">=</span> <span class="n">control_points</span><span class="p">[</span><span class="n">inds1</span><span class="p">]</span>

            <span class="n">inds2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">group2</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">control_points_edges_i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">control_points_edges</span><span class="p">[</span><span class="n">inds2</span><span class="p">])</span>

            <span class="c1"># Remove zeros</span>
            <span class="n">knots_i</span>  <span class="o">=</span> <span class="n">knots_i</span><span class="p">[</span><span class="n">knots_i</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">]</span>
            <span class="n">control_points_i</span> <span class="o">=</span> <span class="n">control_points_i</span><span class="p">[</span><span class="n">control_points_i</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">]</span>

            <span class="n">knots_list</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">logfr</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">knots_i</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">logfr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
            <span class="n">control_pts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">control_points_edges_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">control_points_i</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">control_points_edges_i</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>

            <span class="c1"># Control for knots very close to each other</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">knots_list</span><span class="p">))</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftol</span><span class="p">):</span>
                <span class="c1"># Change the data and reset the spline class</span>
                <span class="n">interp_model</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">knots_list</span><span class="p">,</span> <span class="n">control_pts</span><span class="p">,</span>
                                                    <span class="n">kind</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                    <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                    <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">,</span>
                                                    <span class="n">assume_sorted</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">log_psd_model</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">interp_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logfr</span><span class="p">)</span>

                <span class="c1"># To prevent overflow</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">log_psd_model</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">expmax</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;overflow!&#39;</span><span class="p">)</span>
                    <span class="c1"># breakpoint()</span>
                    <span class="n">i_over</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">log_psd_model</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">expmax</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">log_psd_model</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span>
                    <span class="n">log_psd_model</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i_over</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="n">failed</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i_over</span>
        <span class="c1"># Return the correct quantity</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_psd_model</span><span class="p">),</span> <span class="n">failed</span>

    <span class="k">def</span> <span class="nf">compute_psds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">groups</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute PSD for all channels</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        theta : ndarray</span>
<span class="sd">            PSD parameters</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        s_tot : ndarray</span>
<span class="sd">            PSD estimate, size nf x nchannels</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the noise PSD models</span>
        <span class="n">noise_psd_model</span><span class="p">,</span> <span class="n">failed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_noise_psd_model</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">groups</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">noise_psd_model</span><span class="p">,</span> <span class="n">failed</span>

    <span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">groups</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the log-likelihood.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        c_est : ndarray</span>
<span class="sd">            vector of spline parameters.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ll : float</span>
<span class="sd">            log-likelihood value at x, computed from finds frequencies.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Compute PSD model</span>
        <span class="n">C</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_psds</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">groups</span><span class="p">)</span>

        <span class="c1"># Get the normalisation constants</span>
        <span class="n">log2pi</span> <span class="o">=</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_N</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

        <span class="c1"># Log-likelihood calculation</span>
        <span class="n">L</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span><span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_per</span> <span class="o">/</span> <span class="n">C</span>

        <span class="c1"># Sum the normalization factor here</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="mf">.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Nsegs</span> <span class="o">*</span> <span class="p">(</span> <span class="n">L</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">C</span><span class="p">)</span> <span class="o">+</span> <span class="n">log2pi</span><span class="p">),</span> <span class="n">nan</span><span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">L</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">L</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">inf</span>

        <span class="k">return</span> <span class="n">L</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Instantiate and initalize likelihood again with different ftol</span>
<span class="n">psdlike</span> <span class="o">=</span> <span class="n">SplineLikelihoodDynamic</span><span class="p">(</span><span class="n">fl</span><span class="p">[</span><span class="n">i_band</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">Sl</span><span class="p">[</span><span class="n">i_band</span><span class="p">]),</span> <span class="n">Kavs</span><span class="p">[</span><span class="n">i_band</span><span class="p">],</span> <span class="n">ftol</span><span class="o">=</span><span class="mf">.05</span><span class="p">)</span>

<span class="n">liekeval</span> <span class="o">=</span> <span class="n">psdlike</span><span class="o">.</span><span class="n">evaluate</span><span class="p">([</span><span class="n">coords_in</span><span class="p">[</span><span class="s2">&quot;knots&quot;</span><span class="p">],</span> <span class="n">coords_in</span><span class="p">[</span><span class="s2">&quot;edges&quot;</span><span class="p">]],</span> <span class="p">[</span><span class="n">groups_in</span><span class="p">[</span><span class="s2">&quot;knots&quot;</span><span class="p">],</span> <span class="n">groups_in</span><span class="p">[</span><span class="s2">&quot;edges&quot;</span><span class="p">]])</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;llh shape = &#39;</span><span class="p">,</span> <span class="n">liekeval</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;liekeval = &#39;</span><span class="p">,</span> <span class="n">liekeval</span><span class="p">)</span>

<span class="n">log_prob</span> <span class="o">=</span> <span class="n">liekeval</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ntemps</span><span class="p">,</span> <span class="n">nwalkers</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
llh shape =  (100,)
liekeval =  [-1.00000000e+14 -1.00000000e+14 -1.00000000e+14 -1.00000000e+14
 -1.00000000e+14 -1.00000000e+14 -1.00000000e+14 -1.00000000e+14
 -1.00000000e+14 -1.00000000e+14 -1.00000000e+14 -1.00000000e+14
 -4.38121585e+06 -1.00000000e+14 -1.00000000e+14 -4.31712393e+06
 -1.00000000e+14 -1.00000000e+14 -1.00000000e+14 -1.00000000e+14
 -1.00000000e+14 -1.00000000e+14 -1.00000000e+14 -1.00000000e+14
 -1.00000000e+14 -1.00000000e+14 -1.00000000e+14 -1.00000000e+14
 -4.31768888e+06 -1.00000000e+14 -1.00000000e+14 -1.00000000e+14
 -1.00000000e+14 -1.00000000e+14 -1.00000000e+14 -4.31801556e+06
 -4.35693826e+06 -1.00000000e+14 -1.00000000e+14 -1.00000000e+14
 -1.00000000e+14 -1.00000000e+14 -2.88589297e+08 -1.00000000e+14
 -4.29981691e+06 -1.00000000e+14 -1.00000000e+14 -1.00000000e+14
 -1.00000000e+14 -1.00000000e+14 -1.00000000e+14 -1.00000000e+14
 -1.00000000e+14 -1.00000000e+14 -1.00000000e+14 -4.33027452e+06
 -1.00000000e+14 -4.32030703e+06 -1.00000000e+14 -1.00000000e+14
 -1.00000000e+14 -1.00000000e+14 -1.00000000e+14 -1.00000000e+14
 -1.00000000e+14 -1.00000000e+14 -1.00000000e+14 -1.00000000e+14
 -1.00000000e+14 -1.00000000e+14 -4.38157062e+06 -4.30651446e+06
 -1.00000000e+14 -1.21578998e+50 -1.00000000e+14 -1.00000000e+14
 -1.00000000e+14 -1.00000000e+14 -1.00000000e+14 -1.00000000e+14
 -1.00000000e+14 -1.00000000e+14 -1.00000000e+14 -7.93395923e+11
 -1.00000000e+14 -1.00000000e+14 -1.00000000e+14 -1.00000000e+14
 -4.35353402e+06 -1.00000000e+14 -1.00000000e+14 -4.33570699e+06
 -1.00000000e+14 -1.00000000e+14 -1.00000000e+14 -1.00000000e+14
 -1.00000000e+14 -4.36062530e+06 -1.00000000e+14 -1.00000000e+14]
</pre></div></div>
</div>
<p>Now run the sampler!</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">betas</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">ntemps</span><span class="p">)</span>
<span class="n">factor</span> <span class="o">=</span> <span class="mf">0.0001</span>
<span class="n">cov</span>    <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;knots&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">factor</span><span class="p">,</span>
          <span class="s2">&quot;edges&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">factor</span><span class="p">}</span>

<span class="n">moves</span> <span class="o">=</span> <span class="n">GaussianMove</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>

<span class="n">backend</span> <span class="o">=</span> <span class="n">HDFBackend</span><span class="p">(</span><span class="n">backendname</span> <span class="o">+</span> <span class="s2">&quot;.h5&quot;</span><span class="p">)</span>

<span class="n">ensemble</span> <span class="o">=</span> <span class="n">EnsembleSampler</span><span class="p">(</span>
    <span class="n">nwalkers</span><span class="p">,</span>
    <span class="n">ndims</span><span class="p">,</span>  <span class="c1"># assumes ndim_max</span>
    <span class="n">psdlike</span><span class="o">.</span><span class="n">evaluate</span><span class="p">,</span>
    <span class="n">priors</span><span class="p">,</span>
    <span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">tempering_kwargs</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">betas</span><span class="o">=</span><span class="n">betas</span><span class="p">),</span>
    <span class="n">nbranches</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">branch_names</span><span class="p">),</span>
    <span class="n">branch_names</span><span class="o">=</span><span class="n">branch_names</span><span class="p">,</span>
    <span class="n">nleaves_max</span><span class="o">=</span><span class="n">nleaves_max</span><span class="p">,</span>
    <span class="n">nleaves_min</span><span class="o">=</span><span class="n">nleaves_min</span><span class="p">,</span>
    <span class="n">provide_groups</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">update_iterations</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">plot_iterations</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">moves</span><span class="o">=</span><span class="n">moves</span><span class="p">,</span>
    <span class="n">rj_moves</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">vectorize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">backend</span><span class="o">=</span><span class="n">backend</span><span class="p">,</span>
<span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39; * Started sampling ...&#39;</span><span class="p">)</span>
<span class="n">state</span> <span class="o">=</span> <span class="n">State</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">log_like</span><span class="o">=</span><span class="n">log_prob</span><span class="p">,</span> <span class="n">betas</span><span class="o">=</span><span class="n">betas</span><span class="p">,</span> <span class="n">blobs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inds</span><span class="o">=</span><span class="n">indxs</span><span class="p">)</span>

<span class="n">ensemble</span><span class="o">.</span><span class="n">run_mcmc</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">nsteps</span><span class="p">,</span> <span class="n">burn</span><span class="o">=</span><span class="n">burnin</span><span class="p">,</span> <span class="n">progress</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">thin_by</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39; * Finished sampling!&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
 * Started sampling ...
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
 17%|█▋        | 166/1000 [00:03&lt;00:17, 48.60it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
overflow!
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
 64%|██████▍   | 643/1000 [00:12&lt;00:07, 48.77it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
overflow!
overflow!
overflow!
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
 80%|███████▉  | 797/1000 [00:16&lt;00:04, 50.29it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
overflow!
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|██████████| 1000/1000 [00:20&lt;00:00, 49.42it/s]
100%|██████████| 2000/2000 [01:01&lt;00:00, 32.50it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
 * Finished sampling!
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">baseline_run_backend</span> <span class="o">=</span> <span class="n">HDFBackend</span><span class="p">(</span><span class="n">backendname</span> <span class="o">+</span> <span class="s2">&quot;.h5&quot;</span><span class="p">)</span> <span class="c1"># Load the data from disk</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">temp</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">ndim_knots</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># Set the dimensionality of each model</span>
<span class="n">ndim_edges</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">samples_knots</span> <span class="o">=</span> <span class="n">get_clean_chain</span><span class="p">(</span><span class="n">baseline_run_backend</span><span class="o">.</span><span class="n">get_chain</span><span class="p">()[</span><span class="s1">&#39;knots&#39;</span><span class="p">],</span> <span class="n">ndim_knots</span><span class="p">)</span>
<span class="n">samples_edges</span> <span class="o">=</span> <span class="n">get_clean_chain</span><span class="p">(</span><span class="n">baseline_run_backend</span><span class="o">.</span><span class="n">get_chain</span><span class="p">()[</span><span class="s1">&#39;edges&#39;</span><span class="p">],</span> <span class="n">ndim_edges</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
215132
40000
</pre></div></div>
</div>
<p>Plot the “squeezed” posterior surface for our parameters, for all <code class="docutils literal notranslate"><span class="pre">k</span></code> models.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">paramnames</span> <span class="o">=</span> <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;$\log f_{j,k}$&#39;</span><span class="p">,</span><span class="sa">r</span><span class="s1">&#39;$\log S_{j,k}$&#39;</span><span class="p">]</span> <span class="c1"># Define parameter names</span>

<span class="n">i_band</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">f20</span><span class="o">&gt;=</span><span class="n">f0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">f20</span><span class="o">&lt;=</span><span class="n">f1</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># Keep only the range which we fitted in</span>

<span class="n">c</span> <span class="o">=</span> <span class="n">ChainConsumer</span><span class="p">()</span>
<span class="n">c</span><span class="o">.</span><span class="n">add_chain</span><span class="p">(</span><span class="n">samples_knots</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">paramnames</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Knots in-between&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">)</span>
<span class="n">c</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">bar_shade</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">plot_hists</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">plotter</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">));</span>
<span class="n">ff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">f20</span><span class="p">[</span><span class="n">i_band</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">f20</span><span class="p">[</span><span class="n">i_band</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">num</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="n">ax_list</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">axes</span>
<span class="n">ax_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">noisemodel</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">ff</span><span class="p">))),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;text.usetex&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">True</span> <span class="c1"># Update this becasue chaincnsumer is annoyinh</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_165_0.png" src="../_images/tutorial_Eryn_tutorial_165_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">def</span> <span class="nf">get_clean_k_chains</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="n">temp</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A simple function to get the chains of model order k</span>

<span class="sd">    Args:</span>
<span class="sd">        backend: The Eryn backend</span>

<span class="sd">    Returns:</span>
<span class="sd">        k_chain: the chains of the k order</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">inds</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="s2">&quot;inds&quot;</span><span class="p">)</span>  <span class="c1"># Get the leaves out</span>
    <span class="n">branches</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">inds</span><span class="p">[</span><span class="n">name</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">inds</span><span class="p">}</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">branch</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="n">branches</span><span class="p">):</span>  <span class="c1"># Get the total number of components/branches per temperature</span>
        <span class="k">if</span> <span class="n">branch</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="n">branches</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">k_chain</span> <span class="o">=</span> <span class="n">branches</span><span class="p">[</span><span class="n">branch</span><span class="p">][:,</span> <span class="n">temp</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">k_chain</span> <span class="o">+=</span> <span class="n">branches</span><span class="p">[</span><span class="n">branch</span><span class="p">][:,</span> <span class="n">temp</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">k_chain</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">knots_k_chain</span> <span class="o">=</span> <span class="n">get_clean_k_chains</span><span class="p">(</span><span class="n">baseline_run_backend</span><span class="p">)</span>

<span class="n">bns</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">maxmodels</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span>  <span class="c1"># Get maximum allowed number of leaves for the given branch</span>

<span class="n">mpl</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;text.usetex&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">True</span> <span class="c1"># Update this becasue chaincnsumer is annoying</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">probs</span><span class="p">,</span> <span class="n">bins</span><span class="p">,</span> <span class="n">rects</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
        <span class="n">knots_k_chain</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">bins</span><span class="o">=</span><span class="n">bns</span><span class="p">,</span>
        <span class="n">facecolor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">histtype</span><span class="o">=</span><span class="s1">&#39;step&#39;</span><span class="p">,</span>
        <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span>
        <span class="n">hatch</span><span class="o">=</span><span class="s1">&#39;////&#39;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;knots in-between&#39;</span>
        <span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">maxmodels</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">11</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\#$ of free knots&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 0, &#39;$\\#$ of free knots&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_Eryn_tutorial_167_1.png" src="../_images/tutorial_Eryn_tutorial_167_1.png" />
</div>
</div>
</section>
<section id="\sim-fin-\sim">
<h1><span class="math notranslate nohighlight">\(\sim fin \sim\)</span><a class="headerlink" href="#\sim-fin-\sim" title="Permalink to this headline">¶</a></h1>
</section>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../user/utils.html" class="btn btn-neutral float-left" title="Utilities" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Michael Katz and Nikos Karnesis.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>